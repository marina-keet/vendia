<%- include('partials/header') %>

<div class="container mx-auto px-4 py-8">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-800">
      <i class="fas fa-box text-blue-600 mr-2"></i>Gestion des Produits
    </h1>
    <button onclick="openAddModal()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
      <i class="fas fa-plus mr-2"></i>Nouveau Produit
    </button>
  </div>

  <!-- Filtres -->
  <div class="bg-white rounded-lg shadow-md p-4 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <input type="text" id="searchInput" placeholder="Rechercher un produit..." 
        class="border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500"
        onkeyup="if(event.key === 'Enter') loadProducts()">
      <select id="categoryFilter" class="border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500"
        onchange="loadProducts()">
        <option value="">Toutes les cat√©gories</option>
      </select>
      <button onclick="loadProducts()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
        <i class="fas fa-search mr-2"></i>Rechercher
      </button>
    </div>
  </div>

  <!-- Liste des produits -->
  <div class="bg-white rounded-lg shadow-md overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Produit</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cat√©gorie</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Prix</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Stock</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Code-barres</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
        </tr>
      </thead>
      <tbody id="productsTable" class="bg-white divide-y divide-gray-200">
        <% if (products && products.length > 0) { %>
          <% products.forEach(function(product) { %>
            <tr>
              <td class="px-6 py-4"><%= product.name %></td>
              <td class="px-6 py-4">-</td>
              <td class="px-6 py-4"><%= product.price %></td>
              <td class="px-6 py-4"><%= product.stock %></td>
              <td class="px-6 py-4">-</td>
              <td class="px-6 py-4">Actions</td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr>
            <td colspan="6" class="px-6 py-4 text-center text-gray-500">Aucun produit enregistr√©.</td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal Ajout/Modification -->
<div id="productModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4">
    <h2 id="modalTitle" class="text-2xl font-bold mb-6">Nouveau Produit</h2>
    <form id="productForm" class="space-y-4">
      <input type="hidden" id="productId">
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Nom *</label>
          <input type="text" id="productName" required 
            class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Cat√©gorie</label>
          <input type="text" id="productCategory" 
            class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>

        <div>
          <label for="productPrice" class="block text-sm font-medium text-gray-700 mb-2">Prix *</label>
          <input type="number" id="productPrice" required min="0" 
            class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Stock *</label>
          <input type="number" id="productStock" required min="0" 
            class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Code-barres</label>
          <input type="text" id="productBarcode" 
            class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
        <textarea id="productDescription" rows="3" 
          class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500"></textarea>
      </div>

      <div class="flex justify-end space-x-4 mt-6">
        <button type="button" onclick="closeModal()" 
          class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
          Annuler
        </button>
        <button type="submit" 
          class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
          Enregistrer
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  let products = [];
  let editingId = null;
  let currentCurrency = 'FC';
  let currencySymbol = 'FC';
  let userRole = 'cashier'; // Par d√©faut caissier

  // Charger le r√¥le de l'utilisateur
  async function loadUserRole() {
    try {
      const sessionId = localStorage.getItem('sessionId');
      if (!sessionId) {
        console.log('Pas de session, r√¥le par d√©faut: cashier');
        return;
      }
      
      const response = await fetch('/api/auth/check', {
        headers: { 'X-Session-Id': sessionId }
      });
      const data = await response.json();
      
      if (data.authenticated && data.user) {
        userRole = data.user.role;
        console.log('‚úÖ R√¥le utilisateur charg√©:', userRole);
      }
    } catch (error) {
      console.log('Erreur chargement r√¥le, par d√©faut: cashier', error);
    }
  }

  // Charger les param√®tres de devise
  async function loadCurrencySettings() {
    try {
      const response = await fetch('/api/settings');
      const data = await response.json();
      if (data.settings && data.settings.primary_currency) {
        currentCurrency = data.settings.primary_currency;
        currencySymbol = currentCurrency === 'USD' ? '$' : 'FC';
        
        // Mettre √† jour le label du prix
        const priceLabel = document.querySelector('label[for="productPrice"]');
        if (priceLabel) {
          priceLabel.textContent = `Prix (${currencySymbol}) *`;
        }
      }
    } catch (error) {
      console.log('Utilisation de la devise par d√©faut: FC');
    }
  }

  // Charger les produits
  async function loadProducts() {
    await loadUserRole(); // Charger le r√¥le d'abord
    await loadCurrencySettings(); // Charger la devise d'abord
    try {
      const search = document.getElementById('searchInput').value;
      const category = document.getElementById('categoryFilter').value;
      
      let url = '/api/products?';
      if (search) url += `search=${search}&`;
      if (category) url += `category=${category}&`;
      
      console.log('üîÑ Chargement des produits...');
      const response = await apiRequest(url);
      const data = await response.json();
      console.log('üì¶ Produits re√ßus:', data);
      products = data.products || [];
      console.log('‚úÖ Nombre de produits:', products.length);
      
      displayProducts(products);
      loadCategories();
    } catch (error) {
      console.error('‚ùå Erreur chargement produits:', error);
      alert('Erreur lors du chargement des produits. Veuillez actualiser la page.');
    }
  }

  // Afficher les produits
  function displayProducts(productList) {
    const tbody = document.getElementById('productsTable');
    
    if (productList.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Aucun produit trouv√©</td></tr>';
      return;
    }
    
    // V√©rifier si l'utilisateur est admin pour afficher le bouton supprimer
    const isAdmin = (userRole === 'admin' || userRole === 'manager');
    
    tbody.innerHTML = productList.map(p => `
      <tr class="hover:bg-gray-50">
        <td class="px-6 py-4">
          <div class="font-medium text-gray-900">${p.name}</div>
          <div class="text-sm text-gray-500">${p.description || ''}</div>
        </td>
        <td class="px-6 py-4">${p.category || '-'}</td>
        <td class="px-6 py-4 font-medium">${p.price.toFixed(0)} ${currencySymbol}</td>
        <td class="px-6 py-4">
          <span class="px-3 py-1 rounded-full text-sm ${p.stock <= 5 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
            ${p.stock}
          </span>
        </td>
        <td class="px-6 py-4 text-sm">${p.barcode || '-'}</td>
        <td class="px-6 py-4">
          <button onclick="editProduct('${p._id}')" class="text-blue-600 hover:text-blue-800 mr-3" title="Modifier">
            <i class="fas fa-edit"></i>
          </button>
          ${isAdmin ? `
          <button onclick="deleteProduct('${p._id}')" class="text-red-600 hover:text-red-800" title="Supprimer">
            <i class="fas fa-trash"></i>
          </button>
          ` : `
          <span class="text-gray-300" title="Seul l'administrateur peut supprimer">
            <i class="fas fa-trash"></i>
          </span>
          `}
        </td>
      </tr>
    `).join('');
  }

  // Charger les cat√©gories
  async function loadCategories() {
    try {
      const response = await apiRequest('/api/products/meta/categories');
      const data = await response.json();
      
      const select = document.getElementById('categoryFilter');
      data.categories.forEach(cat => {
        if (!select.querySelector(`option[value="${cat}"]`)) {
          const option = new Option(cat, cat);
          select.add(option);
        }
      });
    } catch (error) {
      console.error('Erreur chargement cat√©gories:', error);
    }
  }

  // Ouvrir modal ajout
  function openAddModal() {
    editingId = null;
    document.getElementById('modalTitle').textContent = 'Nouveau Produit';
    document.getElementById('productForm').reset();
    document.getElementById('productModal').classList.remove('hidden');
  }

  // √âditer un produit
  async function editProduct(id) {
    editingId = id;
    const product = products.find(p => p._id === id);
    
    document.getElementById('modalTitle').textContent = 'Modifier le Produit';
    document.getElementById('productId').value = product._id;
    document.getElementById('productName').value = product.name;
    document.getElementById('productDescription').value = product.description || '';
    document.getElementById('productPrice').value = product.price;
    document.getElementById('productStock').value = product.stock;
    document.getElementById('productCategory').value = product.category || '';
    document.getElementById('productBarcode').value = product.barcode || '';
    
    document.getElementById('productModal').classList.remove('hidden');
  }

  // Fermer modal
  function closeModal() {
    document.getElementById('productModal').classList.add('hidden');
  }

  // Soumettre le formulaire
  document.getElementById('productForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const product = {
      name: document.getElementById('productName').value,
      description: document.getElementById('productDescription').value,
      price: parseFloat(document.getElementById('productPrice').value),
      stock: parseInt(document.getElementById('productStock').value),
      category: document.getElementById('productCategory').value,
      barcode: document.getElementById('productBarcode').value
    };
    
    try {
      const url = editingId ? `/api/products/${editingId}` : '/api/products';
      const method = editingId ? 'PUT' : 'POST';
      
      const response = await apiRequest(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(product)
      });
      
      if (response.ok) {
        closeModal();
        loadProducts();
        alert(editingId ? '‚úÖ Produit modifi√© avec succ√®s!' : '‚úÖ Produit ajout√© avec succ√®s!');
      } else {
        const data = await response.json();
        alert('‚ùå Erreur: ' + (data.error || 'Erreur lors de l\'enregistrement'));
      }
    } catch (error) {
      console.error('Erreur:', error);
      alert('‚ùå Erreur lors de l\'enregistrement: ' + error.message);
    }
  });

  // Supprimer un produit
  async function deleteProduct(id) {
    // V√©rifier si l'utilisateur a le droit de supprimer
    if (userRole !== 'admin' && userRole !== 'manager') {
      alert('‚ùå Seul l\'administrateur ou le g√©rant peut supprimer des produits.');
      return;
    }
    
    if (!confirm('Voulez-vous vraiment supprimer ce produit?')) return;
    
    try {
      const response = await apiRequest(`/api/products/${id}`, { method: 'DELETE' });
      
      if (response.ok) {
        loadProducts();
        alert('‚úÖ Produit supprim√© avec succ√®s!');
      } else {
        const data = await response.json();
        alert('‚ùå ' + (data.error || 'Erreur lors de la suppression'));
      }
    } catch (error) {
      alert('‚ùå Erreur: ' + error.message);
    }
  }

  // Charger au d√©marrage
  loadProducts();
</script>

<%- include('partials/footer') %>
