<%- include('partials/header') %>

<div class="container mx-auto px-4 py-8">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-800">
      <i class="fas fa-cog text-blue-600 mr-2"></i>Paramètres
    </h1>
    <button onclick="saveSettings()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
      <i class="fas fa-save mr-2"></i>Enregistrer
    </button>
  </div>

  <!-- Onglets -->
  <div class="bg-white rounded-lg shadow-md mb-6">
    <div class="border-b border-gray-200">
      <nav class="flex -mb-px">
        <button onclick="showTab('business')" class="tab-btn active px-6 py-4 border-b-2 font-medium text-sm" data-tab="business">
          <i class="fas fa-building mr-2"></i>Entreprise
        </button>
        <button onclick="showTab('general')" class="tab-btn px-6 py-4 border-b-2 font-medium text-sm" data-tab="general">
          <i class="fas fa-sliders-h mr-2"></i>Général
        </button>
        <button onclick="showTab('inventory')" class="tab-btn px-6 py-4 border-b-2 font-medium text-sm" data-tab="inventory">
          <i class="fas fa-boxes mr-2"></i>Inventaire
        </button>
        <button onclick="showTab('receipt')" class="tab-btn px-6 py-4 border-b-2 font-medium text-sm" data-tab="receipt">
          <i class="fas fa-receipt mr-2"></i>Reçus
        </button>
        <button onclick="showTab('loyalty')" class="tab-btn px-6 py-4 border-b-2 font-medium text-sm" data-tab="loyalty">
          <i class="fas fa-star mr-2"></i>Fidélité
        </button>
      </nav>
    </div>
  </div>

  <!-- Contenu des onglets -->
  <div class="bg-white rounded-lg shadow-md p-6">
    <!-- Onglet Entreprise -->
    <div id="tab-business" class="tab-content">
      <h2 class="text-xl font-bold mb-6">Informations de l'Entreprise</h2>
      <div class="space-y-6">
        <!-- Section Logo -->
        <div class="border-b pb-6 mb-6">
          <h3 class="text-lg font-semibold mb-4">
            <i class="fas fa-image text-blue-600 mr-2"></i>Logo de l'entreprise
          </h3>
          <div class="flex items-start gap-6">
            <div id="logoPreview" class="border-2 border-dashed border-gray-300 rounded-lg p-4 w-48 h-48 flex items-center justify-center bg-gray-50">
              <i class="fas fa-image text-gray-400 text-5xl"></i>
            </div>
            <div class="flex-1">
              <p class="text-sm text-gray-600 mb-4">
                Le logo apparaîtra sur les reçus et factures. Formats acceptés : JPG, PNG, GIF, SVG (max 5MB)
              </p>
              <div class="flex gap-2">
                <label for="logoFile" class="cursor-pointer bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition inline-flex items-center">
                  <i class="fas fa-upload mr-2"></i>Choisir un logo
                  <input type="file" id="logoFile" accept="image/*" class="hidden" onchange="uploadLogo()">
                </label>
                <button onclick="deleteLogo()" id="deleteLogoBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition hidden">
                  <i class="fas fa-trash mr-2"></i>Supprimer
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Section Informations -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Nom de l'entreprise</label>
          <input type="text" id="business_name" class="w-full border rounded-lg px-4 py-2">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Adresse</label>
          <textarea id="business_address" rows="3" class="w-full border rounded-lg px-4 py-2"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Téléphone</label>
            <input type="tel" id="business_phone" class="w-full border rounded-lg px-4 py-2">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
            <input type="email" id="business_email" class="w-full border rounded-lg px-4 py-2">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Numéro d'identification fiscale</label>
          <input type="text" id="business_tax_id" class="w-full border rounded-lg px-4 py-2">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            <i class="fas fa-user-tie text-blue-600 mr-2"></i>Nom du Gérant
          </label>
          <input type="text" id="manager_name" placeholder="Nom complet du gérant" class="w-full border rounded-lg px-4 py-2">
          <p class="text-sm text-gray-500 mt-1">Ce nom apparaîtra sur les rapports professionnels</p>
        </div>
      </div>
    </div>

    <!-- Onglet Général -->
    <div id="tab-general" class="tab-content hidden">
      <h2 class="text-xl font-bold mb-6">Paramètres Généraux</h2>
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Devise</label>
            <select id="currency" class="w-full border rounded-lg px-4 py-2">
              <option value="FC">Franc Congolais (FC)</option>
              <option value="USD">Dollar ($)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Position devise</label>
            <select id="currency_position" class="w-full border rounded-lg px-4 py-2">
              <option value="after">Après le montant (1000 FC)</option>
              <option value="before">Avant le montant (FC 1000)</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Taux de TVA (%)</label>
            <input type="number" id="tax_rate" min="0" max="100" step="0.1" class="w-full border rounded-lg px-4 py-2">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">TVA incluse</label>
            <select id="tax_included" class="w-full border rounded-lg px-4 py-2">
              <option value="true">Oui</option>
              <option value="false">Non</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Fuseau horaire</label>
          <select id="timezone" class="w-full border rounded-lg px-4 py-2">
            <option value="Africa/Abidjan">Africa/Abidjan (GMT)</option>
            <option value="Africa/Dakar">Africa/Dakar (GMT)</option>
            <option value="Africa/Lagos">Africa/Lagos (WAT)</option>
            <option value="Europe/Paris">Europe/Paris (CET)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Onglet Inventaire -->
    <div id="tab-inventory" class="tab-content hidden">
      <h2 class="text-xl font-bold mb-6">Gestion du Stock</h2>
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Seuil d'alerte stock bas</label>
            <input type="number" id="low_stock_threshold" min="0" class="w-full border rounded-lg px-4 py-2">
            <p class="text-xs text-gray-500 mt-1">Alerte si quantité ≤ ce seuil</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Seuil stock critique</label>
            <input type="number" id="critical_stock_threshold" min="0" class="w-full border rounded-lg px-4 py-2">
            <p class="text-xs text-gray-500 mt-1">Alerte rouge si quantité ≤ ce seuil</p>
          </div>
        </div>
        <div>
          <label class="flex items-center space-x-3">
            <input type="checkbox" id="auto_restock_alerts" class="h-5 w-5 text-blue-600">
            <span class="text-sm font-medium text-gray-700">Activer les alertes automatiques de réapprovisionnement</span>
          </label>
        </div>
        <div>
          <label class="flex items-center space-x-3">
            <input type="checkbox" id="allow_negative_stock" class="h-5 w-5 text-blue-600">
            <span class="text-sm font-medium text-gray-700">Autoriser les ventes en rupture de stock</span>
          </label>
        </div>
      </div>
    </div>

    <!-- Onglet Reçus -->
    <div id="tab-receipt" class="tab-content hidden">
      <h2 class="text-xl font-bold mb-6">Personnalisation des Reçus et Factures</h2>
      
      <!-- Section Affichage -->
      <div class="mb-8">
        <h3 class="text-lg font-semibold mb-4 text-blue-600">
          <i class="fas fa-eye mr-2"></i>Affichage
        </h3>
        <div class="space-y-3 bg-gray-50 p-4 rounded-lg">
          <label class="flex items-center space-x-3">
            <input type="checkbox" id="receipt_show_logo" class="h-5 w-5 text-blue-600">
            <span class="text-sm font-medium text-gray-700">Afficher le logo de l'entreprise</span>
          </label>
          <label class="flex items-center space-x-3">
            <input type="checkbox" id="receipt_show_company_info" class="h-5 w-5 text-blue-600">
            <span class="text-sm font-medium text-gray-700">Afficher les coordonnées complètes (adresse, téléphone, email)</span>
          </label>
          <label class="flex items-center space-x-3">
            <input type="checkbox" id="receipt_show_tax" class="h-5 w-5 text-blue-600">
            <span class="text-sm font-medium text-gray-700">Afficher le détail de la TVA</span>
          </label>
          <label class="flex items-center space-x-3">
            <input type="checkbox" id="receipt_show_tax_id" class="h-5 w-5 text-blue-600">
            <span class="text-sm font-medium text-gray-700">Afficher le numéro d'identification fiscale</span>
          </label>
          <label class="flex items-center space-x-3">
            <input type="checkbox" id="receipt_show_cashier" class="h-5 w-5 text-blue-600">
            <span class="text-sm font-medium text-gray-700">Afficher le nom du caissier</span>
          </label>
          <label class="flex items-center space-x-3">
            <input type="checkbox" id="receipt_show_customer" class="h-5 w-5 text-blue-600">
            <span class="text-sm font-medium text-gray-700">Afficher les informations du client</span>
          </label>
          <label class="flex items-center space-x-3">
            <input type="checkbox" id="receipt_show_payment_method" class="h-5 w-5 text-blue-600">
            <span class="text-sm font-medium text-gray-700">Afficher le mode de paiement</span>
          </label>
        </div>
      </div>

      <!-- Section Informations Légales -->
      <div class="mb-8">
        <h3 class="text-lg font-semibold mb-4 text-blue-600">
          <i class="fas fa-gavel mr-2"></i>Informations Légales
        </h3>
        <div class="space-y-4 bg-gray-50 p-4 rounded-lg">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-building mr-1"></i>Forme juridique
            </label>
            <input type="text" id="receipt_legal_form" class="w-full border rounded-lg px-4 py-2" 
                   placeholder="Ex: SARL, SA, SPRL, Entreprise individuelle">
            <p class="text-xs text-gray-500 mt-1">Apparaîtra sur les factures officielles</p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-money-check mr-1"></i>Numéro de compte bancaire (IBAN)
            </label>
            <input type="text" id="receipt_bank_account" class="w-full border rounded-lg px-4 py-2" 
                   placeholder="Ex: CD00 0000 0000 0000 0000 0000">
            <p class="text-xs text-gray-500 mt-1">Pour les paiements par virement</p>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-university mr-1"></i>Nom de la banque
            </label>
            <input type="text" id="receipt_bank_name" class="w-full border rounded-lg px-4 py-2" 
                   placeholder="Ex: Equity BCDC, Rawbank, TMB">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-mobile-alt mr-1"></i>Numéro Mobile Money
            </label>
            <input type="text" id="receipt_mobile_money" class="w-full border rounded-lg px-4 py-2" 
                   placeholder="Ex: +243 XXX XXX XXX (M-Pesa, Airtel Money, Orange Money)">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-id-card mr-1"></i>Numéro de registre de commerce (RCCM)
            </label>
            <input type="text" id="receipt_rccm" class="w-full border rounded-lg px-4 py-2" 
                   placeholder="Ex: CD/KNG/RCCM/XX-X-XXXXX">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-certificate mr-1"></i>Numéro d'identification nationale (ID NAT)
            </label>
            <input type="text" id="receipt_id_nat" class="w-full border rounded-lg px-4 py-2" 
                   placeholder="Ex: XX-X-XXXXXXXXX-X">
          </div>
        </div>
      </div>

      <!-- Section Messages Personnalisés -->
      <div class="mb-8">
        <h3 class="text-lg font-semibold mb-4 text-blue-600">
          <i class="fas fa-comment-dots mr-2"></i>Messages Personnalisés
        </h3>
        <div class="space-y-4 bg-gray-50 p-4 rounded-lg">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">En-tête du reçu</label>
            <textarea id="receipt_header" rows="2" class="w-full border rounded-lg px-4 py-2" 
                      placeholder="Ex: Bienvenue chez nous !"></textarea>
            <p class="text-xs text-gray-500 mt-1">Affiché en haut du reçu (optionnel)</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Message de pied de page</label>
            <textarea id="receipt_footer" rows="3" class="w-full border rounded-lg px-4 py-2" 
                      placeholder="Ex: Merci de votre visite ! À bientôt"></textarea>
            <p class="text-xs text-gray-500 mt-1">Affiché en bas du reçu</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Conditions générales de vente (CGV)</label>
            <textarea id="receipt_terms" rows="3" class="w-full border rounded-lg px-4 py-2" 
                      placeholder="Ex: Aucun remboursement après 7 jours. Garantie 30 jours."></textarea>
            <p class="text-xs text-gray-500 mt-1">Conditions légales affichées en petit (optionnel)</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-globe mr-1"></i>Site web
            </label>
            <input type="url" id="receipt_website" class="w-full border rounded-lg px-4 py-2" 
                   placeholder="Ex: https://www.moncommerce.cd">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fab fa-facebook mr-1"></i>Réseaux sociaux
            </label>
            <input type="text" id="receipt_social" class="w-full border rounded-lg px-4 py-2" 
                   placeholder="Ex: @moncommerce (Facebook, Instagram, WhatsApp)">
          </div>
        </div>
      </div>

      <!-- Section Paramètres d'Impression -->
      <div class="mb-8">
        <h3 class="text-lg font-semibold mb-4 text-blue-600">
          <i class="fas fa-print mr-2"></i>Paramètres d'Impression
        </h3>
        <div class="space-y-4 bg-gray-50 p-4 rounded-lg">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Taille du papier</label>
            <select id="receipt_paper_size" class="w-full border rounded-lg px-4 py-2">
              <option value="80mm">80mm (Standard - Imprimante thermique)</option>
              <option value="58mm">58mm (Petit - Imprimante portable)</option>
              <option value="A4">A4 (Facture complète)</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Nombre de copies</label>
            <input type="number" id="receipt_copies" min="1" max="5" value="1" class="w-full border rounded-lg px-4 py-2">
            <p class="text-xs text-gray-500 mt-1">Nombre d'exemplaires à imprimer (1-5)</p>
          </div>

          <label class="flex items-center space-x-3">
            <input type="checkbox" id="receipt_auto_print" class="h-5 w-5 text-blue-600">
            <span class="text-sm font-medium text-gray-700">Impression automatique après chaque vente</span>
          </label>

          <label class="flex items-center space-x-3">
            <input type="checkbox" id="receipt_show_barcode" class="h-5 w-5 text-blue-600">
            <span class="text-sm font-medium text-gray-700">Afficher un code-barres de la facture</span>
          </label>

          <label class="flex items-center space-x-3">
            <input type="checkbox" id="receipt_show_qr" class="h-5 w-5 text-blue-600">
            <span class="text-sm font-medium text-gray-700">Afficher un QR code (pour paiement mobile)</span>
          </label>
        </div>
      </div>
    </div>

    <!-- Onglet Fidélité -->
    <div id="tab-loyalty" class="tab-content hidden">
      <h2 class="text-xl font-bold mb-6">Programme de Fidélité</h2>
      <div class="space-y-4">
        <div>
          <label class="flex items-center space-x-3">
            <input type="checkbox" id="loyalty_enabled" class="h-5 w-5 text-blue-600" onchange="toggleLoyaltySettings()">
            <span class="text-sm font-medium text-gray-700">Activer le programme de fidélité</span>
          </label>
        </div>
        <div id="loyaltySettings" class="space-y-4 pl-8">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Points par FC dépensé</label>
              <input type="number" id="loyalty_points_per_currency" min="0" step="0.01" class="w-full border rounded-lg px-4 py-2">
              <p class="text-xs text-gray-500 mt-1">Ex: 0.1 = 1 point pour 10 FC</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Valeur d'un point (FC)</label>
              <input type="number" id="loyalty_point_value" min="0" step="0.1" class="w-full border rounded-lg px-4 py-2">
              <p class="text-xs text-gray-500 mt-1">Ex: 5 = 1 point = 5 FC</p>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Points minimum pour remise</label>
            <input type="number" id="loyalty_min_points" min="0" class="w-full border rounded-lg px-4 py-2">
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let settings = {};
  let currentLogo = null;

  async function loadSettings() {
    const response = await apiRequest('/api/settings');
    const data = await response.json();
    
    // Supporter les deux formats : ancien (array) et nouveau (objet MongoDB)
    if (Array.isArray(data)) {
      settings = data;
      // Remplir les champs (ancien format)
      settings.forEach(s => {
        const field = document.getElementById(s.key);
        if (field) {
          if (field.type === 'checkbox') {
            field.checked = s.value === 'true' || s.value === true;
          } else {
            field.value = s.value;
          }
        }

        // Charger le logo si disponible
        if (s.key === 'logo' && s.value) {
          currentLogo = s.value;
          displayLogo(s.value);
        }
      });
    } else {
      // Nouveau format (objet MongoDB)
      settings = data;
      
      // Mapper les champs
      const fieldMapping = {
        'business_name': 'companyName',
        'business_address': 'companyAddress',
        'business_phone': 'companyPhone',
        'business_email': 'companyEmail',
        'business_tax_id': 'taxId',
        'manager_name': 'managerName',
        'currency': 'primaryCurrency',
        'currency_position': 'currencyPosition',
        'tax_rate': 'taxRate',
        'tax_included': 'taxIncluded',
        'timezone': 'timezone',
        'low_stock_threshold': 'lowStockThreshold',
        'critical_stock_threshold': 'criticalStockThreshold',
        'auto_restock_alerts': 'autoRestockAlerts',
        'allow_negative_stock': 'allowNegativeStock',
        // Receipt fields
        'receipt_show_logo': 'receiptShowLogo',
        'receipt_show_company_info': 'receiptShowCompanyInfo',
        'receipt_show_tax': 'receiptShowTax',
        'receipt_show_tax_id': 'receiptShowTaxId',
        'receipt_show_cashier': 'receiptShowCashier',
        'receipt_show_customer': 'receiptShowCustomer',
        'receipt_show_payment_method': 'receiptShowPaymentMethod',
        'receipt_header': 'receiptHeader',
        'receipt_footer': 'receiptFooter',
        'receipt_terms': 'receiptTerms',
        'receipt_website': 'receiptWebsite',
        'receipt_social': 'receiptSocial',
        'receipt_legal_form': 'receiptLegalForm',
        'receipt_bank_account': 'receiptBankAccount',
        'receipt_bank_name': 'receiptBankName',
        'receipt_mobile_money': 'receiptMobileMoney',
        'receipt_rccm': 'receiptRccm',
        'receipt_id_nat': 'receiptIdNat',
        'receipt_paper_size': 'receiptPaperSize',
        'receipt_copies': 'receiptCopies',
        'receipt_auto_print': 'receiptAutoPrint',
        'receipt_show_barcode': 'receiptShowBarcode',
        'receipt_show_qr': 'receiptShowQr'
      };
      
      for (const [fieldId, settingKey] of Object.entries(fieldMapping)) {
        const field = document.getElementById(fieldId);
        if (field && settings[settingKey] !== undefined) {
          if (field.type === 'checkbox') {
            field.checked = settings[settingKey] === true || settings[settingKey] === 'true';
          } else {
            field.value = settings[settingKey];
          }
        }
      }
      
      // Si primaryCurrency n'est pas défini, mettre FC par défaut
      const currencyField = document.getElementById('currency');
      if (currencyField && !currencyField.value) {
        currencyField.value = 'FC';
      }

      // Charger le logo depuis MongoDB
      if (settings.logo) {
        currentLogo = settings.logo;
        displayLogo(settings.logo);
      }

      // Loyalty fields (new Mongo format)
      if (settings.loyaltyEnabled !== undefined) {
        document.getElementById('loyalty_enabled').checked = !!settings.loyaltyEnabled;
      }
      if (settings.loyaltyPointsPerCurrency !== undefined) {
        document.getElementById('loyalty_points_per_currency').value = settings.loyaltyPointsPerCurrency;
      }
      if (settings.loyaltyPointValue !== undefined) {
        document.getElementById('loyalty_point_value').value = settings.loyaltyPointValue;
      }
      if (settings.loyaltyMinPoints !== undefined) {
        document.getElementById('loyalty_min_points').value = settings.loyaltyMinPoints;
      }
    }

    toggleLoyaltySettings();
  }

  function displayLogo(logoUrl) {
    const preview = document.getElementById('logoPreview');
    preview.innerHTML = `<img src="${logoUrl}" alt="Logo" class="max-w-full max-h-full object-contain">`;
    document.getElementById('deleteLogoBtn').classList.remove('hidden');
  }

  async function uploadLogo() {
    const fileInput = document.getElementById('logoFile');
    const file = fileInput.files[0];

    if (!file) return;

    // Vérifier la taille (5MB max)
    if (file.size > 5 * 1024 * 1024) {
      alert('Le fichier est trop volumineux. Taille maximum : 5MB');
      return;
    }

    // Vérifier le type
    if (!file.type.startsWith('image/')) {
      alert('Veuillez sélectionner une image valide');
      return;
    }

    const formData = new FormData();
    formData.append('logo', file);

    try {
      const response = await apiRequest('/api/settings/upload-logo', {
        method: 'POST',
        body: formData
      });

      if (response.ok) {
        const data = await response.json();
        displayLogo(data.logoUrl);
        alert('Logo uploadé avec succès!');
      } else {
        const error = await response.json();
        alert('Erreur: ' + error.error);
      }
    } catch (error) {
      alert('Erreur lors de l\'upload: ' + error.message);
    }
  }

  async function deleteLogo() {
    if (!confirm('Êtes-vous sûr de vouloir supprimer le logo ?')) return;

    try {
      const response = await apiRequest('/api/settings/logo', {
        method: 'DELETE'
      });

      if (response.ok) {
        const preview = document.getElementById('logoPreview');
        preview.innerHTML = '<i class="fas fa-image text-gray-400 text-5xl"></i>';
        document.getElementById('deleteLogoBtn').classList.add('hidden');
        currentLogo = null;
        alert('Logo supprimé avec succès!');
      } else {
        const error = await response.json();
        alert('Erreur: ' + error.error);
      }
    } catch (error) {
      alert('Erreur lors de la suppression: ' + error.message);
    }
  }

  function showTab(tabName) {
    // Masquer tous les contenus
    document.querySelectorAll('.tab-content').forEach(tab => {
      tab.classList.add('hidden');
    });
    
    // Désactiver tous les boutons
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
      btn.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Afficher le contenu sélectionné
    document.getElementById('tab-' + tabName).classList.remove('hidden');
    
    // Activer le bouton sélectionné
    const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
    activeBtn.classList.add('active', 'border-blue-500', 'text-blue-600');
    activeBtn.classList.remove('border-transparent', 'text-gray-500');
  }

  function toggleLoyaltySettings() {
    const enabled = document.getElementById('loyalty_enabled').checked;
    const settingsDiv = document.getElementById('loyaltySettings');
    
    if (enabled) {
      settingsDiv.classList.remove('opacity-50', 'pointer-events-none');
    } else {
      settingsDiv.classList.add('opacity-50', 'pointer-events-none');
    }
  }

  async function saveSettings() {
    try {
      // Préparer les données au format MongoDB avec TOUS les champs
      const currencyValue = document.getElementById('currency').value || 'FC'; // Valeur par défaut
      
      const mongoSettings = {
        // Business info
        companyName: document.getElementById('business_name').value || 'Ma Boutique',
        companyAddress: document.getElementById('business_address').value || '',
        companyPhone: document.getElementById('business_phone').value || '',
        companyEmail: document.getElementById('business_email').value || '',
        taxId: document.getElementById('business_tax_id').value || '',
        managerName: document.getElementById('manager_name').value || 'Gérant',
        
        // General settings
        primaryCurrency: currencyValue,
        currencyPosition: document.getElementById('currency_position').value || 'before',
        taxRate: parseFloat(document.getElementById('tax_rate').value) || 0,
        taxIncluded: document.getElementById('tax_included').value === 'true',
        timezone: document.getElementById('timezone').value || 'Africa/Kinshasa',
        
        // Inventory settings
        lowStockThreshold: parseInt(document.getElementById('low_stock_threshold').value) || 10,
        criticalStockThreshold: parseInt(document.getElementById('critical_stock_threshold').value) || 5,
        autoRestockAlerts: document.getElementById('auto_restock_alerts').checked,
        allowNegativeStock: document.getElementById('allow_negative_stock').checked,
        
        // Receipt settings - Affichage
        receiptShowLogo: document.getElementById('receipt_show_logo').checked,
        receiptShowCompanyInfo: document.getElementById('receipt_show_company_info').checked,
        receiptShowTax: document.getElementById('receipt_show_tax').checked,
        receiptShowTaxId: document.getElementById('receipt_show_tax_id').checked,
        receiptShowCashier: document.getElementById('receipt_show_cashier').checked,
        receiptShowCustomer: document.getElementById('receipt_show_customer').checked,
        receiptShowPaymentMethod: document.getElementById('receipt_show_payment_method').checked,
        
        // Receipt settings - Informations légales
        receiptLegalForm: document.getElementById('receipt_legal_form').value || '',
        receiptBankAccount: document.getElementById('receipt_bank_account').value || '',
        receiptBankName: document.getElementById('receipt_bank_name').value || '',
        receiptMobileMoney: document.getElementById('receipt_mobile_money').value || '',
        receiptRccm: document.getElementById('receipt_rccm').value || '',
        receiptIdNat: document.getElementById('receipt_id_nat').value || '',
        
        // Receipt settings - Messages personnalisés
        receiptHeader: document.getElementById('receipt_header').value || '',
        receiptFooter: document.getElementById('receipt_footer').value || 'Merci de votre visite!',
        receiptTerms: document.getElementById('receipt_terms').value || '',
        receiptWebsite: document.getElementById('receipt_website').value || '',
        receiptSocial: document.getElementById('receipt_social').value || '',
        
        // Receipt settings - Impression
        receiptPaperSize: document.getElementById('receipt_paper_size').value || '80mm',
        receiptCopies: parseInt(document.getElementById('receipt_copies').value) || 1,
        receiptAutoPrint: document.getElementById('receipt_auto_print').checked,
        receiptShowBarcode: document.getElementById('receipt_show_barcode').checked,
        receiptShowQr: document.getElementById('receipt_show_qr').checked,
        
        // Loyalty settings
        loyaltyEnabled: document.getElementById('loyalty_enabled').checked,
        loyaltyPointsPerCurrency: parseFloat(document.getElementById('loyalty_points_per_currency').value) || 0,
        loyaltyPointValue: parseFloat(document.getElementById('loyalty_point_value').value) || 0,
        loyaltyMinPoints: parseInt(document.getElementById('loyalty_min_points').value) || 0
      };
      
      const response = await apiRequest('/api/settings', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(mongoSettings)
      });

      if (response.ok) {
        const result = await response.json();
        Swal.fire({
          icon: 'success',
          title: 'Succès !',
          text: 'Paramètres enregistrés avec succès',
          confirmButtonText: 'OK'
        });
        loadSettings(); // Recharger pour confirmer
      } else {
        const error = await response.json();
        Swal.fire({
          icon: 'error',
          title: 'Erreur',
          text: error.message || 'Erreur lors de l\'enregistrement',
          confirmButtonText: 'OK'
        });
      }
    } catch (error) {
      Swal.fire({
        icon: 'error',
        title: 'Erreur',
        text: 'Erreur lors de l\'enregistrement: ' + error.message,
        confirmButtonText: 'OK'
      });
    }
  }

  // Initialisation
  loadSettings();
</script>

<style>
  .tab-btn.active {
    border-color: #2563eb;
    color: #2563eb;
  }
  .tab-btn:not(.active) {
    border-color: transparent;
    color: #6b7280;
  }
  .tab-btn:hover:not(.active) {
    color: #374151;
    border-color: #d1d5db;
  }
</style>

<%- include('partials/footer') %>
