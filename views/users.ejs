<%- include('partials/header') %>

<div class="container mx-auto px-4 py-8">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-800">
      <i class="fas fa-user-cog text-blue-600 mr-2"></i>Gestion des Utilisateurs
    </h1>
    <button onclick="openUserModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
      <i class="fas fa-plus mr-2"></i>Nouvel Utilisateur
    </button>
  </div>

  <!-- Liste des utilisateurs -->
  <div class="bg-white rounded-lg shadow-md overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Utilisateur</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rôle</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Statut</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Créé le</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
        </tr>
      </thead>
      <tbody id="usersTable" class="bg-white divide-y divide-gray-200">
        <tr>
          <td colspan="6" class="px-6 py-4 text-center text-gray-500">
            <i class="fas fa-spinner fa-spin mr-2"></i>Chargement...
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal Utilisateur -->
<div id="userModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4">
    <div class="flex justify-between items-start mb-6">
      <h2 class="text-2xl font-bold" id="modalTitle">Nouvel Utilisateur</h2>
      <button onclick="closeUserModal()" class="text-gray-500 hover:text-gray-700">
        <i class="fas fa-times text-2xl"></i>
      </button>
    </div>

    <form id="userForm" class="space-y-4">
      <input type="hidden" id="userId">
      
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Nom d'utilisateur *</label>
          <input type="text" id="username" required 
                 class="w-full border rounded-lg px-4 py-2">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
          <input type="email" id="email" 
                 class="w-full border rounded-lg px-4 py-2">
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Nom complet *</label>
          <input type="text" id="fullName" required 
                 class="w-full border rounded-lg px-4 py-2">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Rôle *</label>
          <select id="role" required class="w-full border rounded-lg px-4 py-2">
            <option value="cashier">Caissier</option>
            <option value="manager">Gérant</option>
            <option value="admin">Administrateur</option>
          </select>
        </div>
      </div>

      <div id="passwordSection">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Mot de passe <span id="passwordRequired">*</span>
            </label>
            <input type="password" id="password" 
                   class="w-full border rounded-lg px-4 py-2">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Confirmer <span id="confirmRequired">*</span>
            </label>
            <input type="password" id="confirmPassword" 
                   class="w-full border rounded-lg px-4 py-2">
          </div>
        </div>
      </div>

      <div class="flex justify-end space-x-4 pt-4">
        <button type="button" onclick="closeUserModal()" 
                class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-300">
          Annuler
        </button>
        <button type="submit" 
                class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
          <i class="fas fa-save mr-2"></i>Enregistrer
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Changer Mot de Passe -->
<div id="passwordModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
    <div class="flex justify-between items-start mb-6">
      <h2 class="text-2xl font-bold">Changer le Mot de Passe</h2>
      <button onclick="closePasswordModal()" class="text-gray-500 hover:text-gray-700">
        <i class="fas fa-times text-2xl"></i>
      </button>
    </div>

    <form id="passwordForm" class="space-y-4">
      <input type="hidden" id="passwordUserId">
      
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Nouveau mot de passe</label>
        <input type="password" id="newPassword" required 
               class="w-full border rounded-lg px-4 py-2">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Confirmer</label>
        <input type="password" id="confirmNewPassword" required 
               class="w-full border rounded-lg px-4 py-2">
      </div>

      <div class="flex justify-end space-x-4 pt-4">
        <button type="button" onclick="closePasswordModal()" 
                class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-300">
          Annuler
        </button>
        <button type="submit" 
                class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
          <i class="fas fa-key mr-2"></i>Changer
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  let users = [];
  let currentUser = JSON.parse(localStorage.getItem('user')) || {};

  async function loadUsers() {
    try {
      const response = await apiRequest('/api/users');
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Erreur de chargement');
      }
      
      const data = await response.json();
      users = data.users || [];
      console.log('Utilisateurs chargés:', users);
      displayUsers(users);
    } catch (error) {
      console.error('Erreur chargement utilisateurs:', error);
      document.getElementById('usersTable').innerHTML = 
        `<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">
          <i class="fas fa-exclamation-triangle mr-2"></i>
          ${error.message || 'Erreur de chargement des utilisateurs'}
        </td></tr>`;
    }
  }

  function displayUsers(data) {
    const tbody = document.getElementById('usersTable');
    
    if (data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Aucun utilisateur trouvé</td></tr>';
      return;
    }
    
    tbody.innerHTML = data.map(u => {
      const userId = u._id || u.id;
      return `
      <tr class="hover:bg-gray-50">
        <td class="px-6 py-4">
          <div class="flex items-center">
            <div class="h-10 w-10 flex-shrink-0">
              <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                <i class="fas fa-user text-blue-600"></i>
              </div>
            </div>
            <div class="ml-4">
              <div class="font-medium text-gray-900">${u.fullName || u.username}</div>
              <div class="text-sm text-gray-500">@${u.username}</div>
            </div>
          </div>
        </td>
        <td class="px-6 py-4">
          <span class="px-2 py-1 rounded text-sm ${getRoleBadge(u.role)}">
            ${getRoleLabel(u.role)}
          </span>
        </td>
        <td class="px-6 py-4 text-sm text-gray-600">${u.email || '-'}</td>
        <td class="px-6 py-4">
          <span class="px-2 py-1 rounded text-sm bg-green-100 text-green-800">
            Actif
          </span>
        </td>
        <td class="px-6 py-4 text-sm text-gray-600">${new Date(u.createdAt).toLocaleDateString('fr-FR')}</td>
        <td class="px-6 py-4 space-x-2">
          <button onclick="editUser('${userId}')" class="text-yellow-600 hover:text-yellow-800" title="Modifier">
            <i class="fas fa-edit"></i>
          </button>
          <button onclick="changePassword('${userId}')" class="text-blue-600 hover:text-blue-800" title="Changer mot de passe">
            <i class="fas fa-key"></i>
          </button>
          ${currentUser._id !== userId && currentUser.id !== userId ? `
            <button onclick="deleteUser('${userId}', '${u.username}')" class="text-red-600 hover:text-red-800" title="Supprimer">
              <i class="fas fa-trash"></i>
            </button>
          ` : ''}
        </td>
      </tr>
    `}).join('');
  }

  function getRoleLabel(role) {
    const labels = {
      'admin': 'Administrateur',
      'manager': 'Gérant',
      'cashier': 'Caissier'
    };
    return labels[role] || role;
  }

  function getRoleBadge(role) {
    const badges = {
      'admin': 'bg-red-100 text-red-800',
      'manager': 'bg-blue-100 text-blue-800',
      'cashier': 'bg-green-100 text-green-800'
    };
    return badges[role] || 'bg-gray-100 text-gray-800';
  }

  function openUserModal(user = null) {
    const isEdit = user !== null;
    document.getElementById('modalTitle').textContent = isEdit ? 'Modifier l\'Utilisateur' : 'Nouvel Utilisateur';
    document.getElementById('userId').value = isEdit ? (user._id || user.id) : '';
    document.getElementById('username').value = isEdit ? user.username : '';
    document.getElementById('email').value = isEdit ? (user.email || '') : '';
    document.getElementById('fullName').value = isEdit ? user.fullName : '';
    document.getElementById('role').value = isEdit ? user.role : 'cashier';
    
    // Mot de passe optionnel en modification
    if (isEdit) {
      document.getElementById('password').required = false;
      document.getElementById('confirmPassword').required = false;
      document.getElementById('passwordRequired').textContent = '(optionnel)';
      document.getElementById('confirmRequired').textContent = '(optionnel)';
    } else {
      document.getElementById('password').required = true;
      document.getElementById('confirmPassword').required = true;
      document.getElementById('passwordRequired').textContent = '*';
      document.getElementById('confirmRequired').textContent = '*';
    }
    
    document.getElementById('userModal').classList.remove('hidden');
  }

  function closeUserModal() {
    document.getElementById('userModal').classList.add('hidden');
    document.getElementById('userForm').reset();
  }

  document.getElementById('userForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const id = document.getElementById('userId').value;
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    // Vérifier les mots de passe
    if (password || confirmPassword) {
      if (password !== confirmPassword) {
        alert('Les mots de passe ne correspondent pas!');
        return;
      }
      if (password.length < 6) {
        alert('Le mot de passe doit contenir au moins 6 caractères!');
        return;
      }
    }
    
    const data = {
      username: document.getElementById('username').value,
      email: document.getElementById('email').value || null,
      full_name: document.getElementById('fullName').value,
      role: document.getElementById('role').value
    };
    
    if (password) {
      data.password = password;
    }
    
    try {
      const url = id ? `/api/users/${id}` : '/api/users';
      const method = id ? 'PUT' : 'POST';
      
      const response = await apiRequest(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      
      if (response.ok) {
        closeUserModal();
        loadUsers();
        alert(id ? 'Utilisateur modifié avec succès!' : 'Utilisateur créé avec succès!');
      } else {
        const error = await response.json();
        alert('Erreur: ' + error.message);
      }
    } catch (error) {
      alert('Erreur lors de l\'enregistrement: ' + error.message);
    }
  });

  async function editUser(id) {
    const user = users.find(u => (u._id || u.id) === id);
    if (user) {
      openUserModal(user);
    }
  }

  function changePassword(id) {
    document.getElementById('passwordUserId').value = id;
    document.getElementById('passwordModal').classList.remove('hidden');
  }

  function closePasswordModal() {
    document.getElementById('passwordModal').classList.add('hidden');
    document.getElementById('passwordForm').reset();
  }

  document.getElementById('passwordForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const id = document.getElementById('passwordUserId').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmNewPassword = document.getElementById('confirmNewPassword').value;
    
    if (newPassword !== confirmNewPassword) {
      alert('Les mots de passe ne correspondent pas!');
      return;
    }
    
    if (newPassword.length < 6) {
      alert('Le mot de passe doit contenir au moins 6 caractères!');
      return;
    }
    
    try {
      const response = await apiRequest(`/api/users/${id}/password`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ newPassword })
      });
      
      if (response.ok) {
        closePasswordModal();
        alert('Mot de passe modifié avec succès!');
      } else {
        const error = await response.json();
        alert('Erreur: ' + error.message);
      }
    } catch (error) {
      alert('Erreur lors du changement de mot de passe: ' + error.message);
    }
  });

  async function deleteUser(id, username) {
    if (!confirm(`Êtes-vous sûr de vouloir supprimer l'utilisateur "${username}" ?`)) {
      return;
    }
    
    try {
      const response = await apiRequest(`/api/users/${id}`, {
        method: 'DELETE'
      });
      
      if (response.ok) {
        loadUsers();
        alert('Utilisateur supprimé avec succès!');
      } else {
        const error = await response.json();
        alert('Erreur: ' + error.message);
      }
    } catch (error) {
      alert('Erreur lors de la suppression: ' + error.message);
    }
  }

  // Charger au démarrage
  loadUsers();
</script>

<%- include('partials/footer') %>
