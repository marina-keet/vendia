<%- include('partials/header') %>

<div class="container mx-auto px-4 py-8">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-800">
      <i class="fas fa-users text-blue-600 mr-2"></i>Gestion des Clients
    </h1>
    <div class="flex items-center gap-4">
      <!-- Boutons de devise -->
      <div class="flex gap-2">
        <button onclick="setCurrency('FC')" id="btnFC" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition">
          <i class="fas fa-coins mr-1"></i>FC
        </button>
        <button onclick="setCurrency('USD')" id="btnUSD" class="px-4 py-2 rounded-lg bg-gray-300 text-gray-700 hover:bg-gray-400 transition">
          <i class="fas fa-dollar-sign mr-1"></i>USD
        </button>
      </div>
      <button onclick="openCustomerModal()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
        <i class="fas fa-plus mr-2"></i>Nouveau Client
      </button>
    </div>
  </div>

  <!-- Recherche -->
  <div class="bg-white rounded-lg shadow-md p-4 mb-6">
    <div class="flex space-x-4">
      <div class="flex-1">
        <input type="text" id="searchInput" placeholder="Rechercher un client (nom, t√©l√©phone, email)..." 
               class="w-full border rounded-lg px-4 py-2" onkeyup="searchCustomers()">
      </div>
      <button onclick="searchCustomers()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
        <i class="fas fa-search"></i>
      </button>
    </div>
  </div>

  <!-- Liste des clients -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="customersList">
    <div class="col-span-full text-center py-12 text-gray-500">
      <i class="fas fa-spinner fa-spin text-3xl mb-4"></i>
      <p>Chargement des clients...</p>
    </div>
  </div>
</div>

<!-- Modal Client -->
<div id="customerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-start mb-6">
      <h2 class="text-2xl font-bold" id="modalTitle">Nouveau Client</h2>
      <button onclick="closeCustomerModal()" class="text-gray-500 hover:text-gray-700">
        <i class="fas fa-times text-2xl"></i>
      </button>
    </div>

    <form id="customerForm" class="space-y-4">
      <input type="hidden" id="customerId">
      
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Nom complet *</label>
          <input type="text" id="customerName" required 
                 class="w-full border rounded-lg px-4 py-2">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">T√©l√©phone *</label>
          <input type="tel" id="customerPhone" required 
                 class="w-full border rounded-lg px-4 py-2">
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
        <input type="email" id="customerEmail" 
               class="w-full border rounded-lg px-4 py-2">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Adresse</label>
        <textarea id="customerAddress" rows="3" 
                  class="w-full border rounded-lg px-4 py-2"></textarea>
      </div>

      <div class="flex justify-end space-x-4 pt-4">
        <button type="button" onclick="closeCustomerModal()" 
                class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-300">
          Annuler
        </button>
        <button type="submit" 
                class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
          <i class="fas fa-save mr-2"></i>Enregistrer
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal D√©tails Client -->
<div id="customerDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-start mb-6">
      <h2 class="text-2xl font-bold">D√©tails du Client</h2>
      <button onclick="closeDetailsModal()" class="text-gray-500 hover:text-gray-700">
        <i class="fas fa-times text-2xl"></i>
      </button>
    </div>

    <div id="customerDetailsContent"></div>

    <div class="mt-6 flex justify-end">
      <button onclick="closeDetailsModal()" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-300">
        Fermer
      </button>
    </div>
  </div>
</div>

<script>
  let customers = [];
  let currentUser = JSON.parse(localStorage.getItem('user')) || {};
  let currentCurrency = 'FC';
  let exchangeRate = 2450; // 1 USD = 2450 FC

  function formatCurrency(amount) {
    const value = currentCurrency === 'USD' ? (amount / exchangeRate) : amount;
    const formatted = new Intl.NumberFormat('fr-FR', { 
      minimumFractionDigits: currentCurrency === 'USD' ? 2 : 0,
      maximumFractionDigits: currentCurrency === 'USD' ? 2 : 0
    }).format(value);
    return `${formatted} ${currentCurrency}`;
  }

  function setCurrency(currency) {
    currentCurrency = currency;
    
    // Mettre √† jour les styles des boutons
    if (currency === 'FC') {
      document.getElementById('btnFC').className = 'px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition';
      document.getElementById('btnUSD').className = 'px-4 py-2 rounded-lg bg-gray-300 text-gray-700 hover:bg-gray-400 transition';
    } else {
      document.getElementById('btnFC').className = 'px-4 py-2 rounded-lg bg-gray-300 text-gray-700 hover:bg-gray-400 transition';
      document.getElementById('btnUSD').className = 'px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition';
    }
    
    displayCustomers(customers);
  }

  async function loadCustomers() {
    const response = await apiRequest('/api/customers');
    customers = await response.json();
    displayCustomers(customers);
  }

  function displayCustomers(data) {
    const container = document.getElementById('customersList');
    
    if (data.length === 0) {
      container.innerHTML = `
        <div class="col-span-full text-center py-12 text-gray-500">
          <i class="fas fa-users text-5xl mb-4"></i>
          <p>Aucun client trouv√©</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = data.map(c => `
      <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition">
        <div class="flex justify-between items-start mb-4">
          <div>
            <h3 class="text-xl font-bold text-gray-800">${c.name}</h3>
            <p class="text-sm text-gray-500">Client #${c._id}</p>
          </div>
          <div class="flex space-x-2">
            <button data-customer-id="${c._id}" class="view-customer-btn text-blue-600 hover:text-blue-800" title="Voir d√©tails">
              <i class="fas fa-eye"></i>
            </button>
            <button data-customer-id="${c._id}" class="edit-customer-btn text-yellow-600 hover:text-yellow-800" title="Modifier">
              <i class="fas fa-edit"></i>
            </button>
            ${(currentUser.role === 'admin' || currentUser.role === 'manager') ? `
              <button data-customer-id="${c._id}" data-customer-name="${c.name}" class="delete-customer-btn text-red-600 hover:text-red-800" title="Supprimer">
                <i class="fas fa-trash"></i>
              </button>
            ` : ''}
          </div>
        </div>

        <div class="space-y-2">
          <p class="flex items-center text-gray-600">
            <i class="fas fa-phone w-5 mr-2"></i>
            ${c.phone}
          </p>
          ${c.email ? `
            <p class="flex items-center text-gray-600">
              <i class="fas fa-envelope w-5 mr-2"></i>
              ${c.email}
            </p>
          ` : ''}
          ${c.address ? `
            <p class="flex items-center text-gray-600">
              <i class="fas fa-map-marker-alt w-5 mr-2"></i>
              ${c.address}
            </p>
          ` : ''}
        </div>

        <div class="mt-4 pt-4 border-t flex justify-between items-center">
          <div>
            <p class="text-xs text-gray-500">Points fid√©lit√©</p>
            <p class="text-lg font-bold text-blue-600">${c.loyalty_points || 0}</p>
          </div>
          <div class="text-right">
            <p class="text-xs text-gray-500">Membre depuis</p>
            <p class="text-sm font-medium">${new Date(c.member_since || c.created_at).toLocaleDateString('fr-FR')}</p>
          </div>
        </div>
      </div>
    `).join('');
  }

  async function searchCustomers() {
    const search = document.getElementById('searchInput').value.trim();
    
    if (!search) {
      displayCustomers(customers);
      return;
    }
    
    const response = await apiRequest(`/api/customers?search=${encodeURIComponent(search)}`);
    const data = await response.json();
    displayCustomers(data);
  }

  function openCustomerModal(customer = null) {
    document.getElementById('modalTitle').textContent = customer ? 'Modifier le Client' : 'Nouveau Client';
    document.getElementById('customerId').value = customer ? (customer._id || customer.id) : '';
    document.getElementById('customerName').value = customer ? customer.name : '';
    document.getElementById('customerPhone').value = customer ? customer.phone : '';
    document.getElementById('customerEmail').value = customer ? customer.email || '' : '';
    document.getElementById('customerAddress').value = customer ? customer.address || '' : '';
    document.getElementById('customerModal').classList.remove('hidden');
  }

  function closeCustomerModal() {
    document.getElementById('customerModal').classList.add('hidden');
    document.getElementById('customerForm').reset();
  }

  document.getElementById('customerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const id = document.getElementById('customerId').value;
    const data = {
      name: document.getElementById('customerName').value,
      phone: document.getElementById('customerPhone').value,
      email: document.getElementById('customerEmail').value || null,
      address: document.getElementById('customerAddress').value || null
    };
    
    try {
      const url = id ? `/api/customers/${id}` : '/api/customers';
      const method = id ? 'PUT' : 'POST';
      
      const response = await apiRequest(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      
      if (response.ok) {
        closeCustomerModal();
        loadCustomers();
        alert(id ? 'Client modifi√© avec succ√®s!' : 'Client ajout√© avec succ√®s!');
      } else {
        const error = await response.json();
        alert('Erreur: ' + error.message);
      }
    } catch (error) {
      alert('Erreur lors de l\'enregistrement: ' + error.message);
    }
  });

  async function editCustomer(id) {
    try {
      console.log('‚úèÔ∏è Modification du client:', id);
      const response = await apiRequest(`/api/customers/${id}`);
      const data = await response.json();
      console.log('üì¶ Donn√©es client pour modification:', data);
      
      if (data.customer) {
        openCustomerModal(data.customer);
      }
    } catch (error) {
      console.error('‚ùå Erreur lors du chargement pour modification:', error);
      alert('Erreur lors du chargement du client: ' + error.message);
    }
  }

  async function deleteCustomer(id, name) {
    if (!confirm(`√ätes-vous s√ªr de vouloir supprimer le client "${name}" ?`)) {
      return;
    }
    
    try {
      const response = await apiRequest(`/api/customers/${id}`, {
        method: 'DELETE'
      });
      
      if (response.ok) {
        loadCustomers();
        alert('Client supprim√© avec succ√®s!');
      } else {
        const error = await response.json();
        alert('Erreur: ' + error.message);
      }
    } catch (error) {
      alert('Erreur lors de la suppression: ' + error.message);
    }
  }

  async function viewCustomer(id) {
    try {
      console.log('üîç Chargement des d√©tails du client:', id);
      
      const response = await apiRequest(`/api/customers/${id}`);
      const data = await response.json();
      console.log('üì¶ Donn√©es client re√ßues:', data);
      
      const statsResponse = await apiRequest(`/api/customers/${id}/stats`);
      const stats = await statsResponse.json();
      console.log('üìä Statistiques re√ßues:', stats);
    
    const detailsHtml = `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-blue-50 p-4 rounded-lg">
          <p class="text-sm text-blue-600 font-medium">Total Achats</p>
          <p class="text-2xl font-bold text-blue-800">${formatCurrency(stats.totalPurchases)}</p>
        </div>
        <div class="bg-green-50 p-4 rounded-lg">
          <p class="text-sm text-green-600 font-medium">Nombre de Ventes</p>
          <p class="text-2xl font-bold text-green-800">${stats.totalSales}</p>
        </div>
        <div class="bg-purple-50 p-4 rounded-lg">
          <p class="text-sm text-purple-600 font-medium">Points Fid√©lit√©</p>
          <p class="text-2xl font-bold text-purple-800">${data.customer.loyalty_points || 0}</p>
        </div>
      </div>

      <div class="bg-gray-50 p-4 rounded-lg mb-6">
        <h3 class="font-bold text-lg mb-3">Informations</h3>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <p class="text-sm text-gray-500">Nom complet</p>
            <p class="font-medium">${data.customer.name}</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">T√©l√©phone</p>
            <p class="font-medium">${data.customer.phone}</p>
          </div>
          ${data.customer.email ? `
            <div>
              <p class="text-sm text-gray-500">Email</p>
              <p class="font-medium">${data.customer.email}</p>
            </div>
          ` : ''}
          ${data.customer.address ? `
            <div class="col-span-2">
              <p class="text-sm text-gray-500">Adresse</p>
              <p class="font-medium">${data.customer.address}</p>
            </div>
          ` : ''}
        </div>
      </div>

      ${data.sales && data.sales.length > 0 ? `
        <div>
          <h3 class="font-bold text-lg mb-3">Historique des achats (${data.sales.length} derni√®res ventes)</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Date</th>
                  <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">N¬∞ Vente</th>
                  <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">Montant</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200">
                ${data.sales.map(s => `
                  <tr>
                    <td class="px-4 py-2">${new Date(s.created_at).toLocaleDateString('fr-FR')}</td>
                    <td class="px-4 py-2">#${s.id}</td>
                    <td class="px-4 py-2 text-right font-bold">${formatCurrency(s.final_amount)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      ` : '<p class="text-gray-500 text-center py-4">Aucun achat enregistr√©</p>'}
    `;
    
    document.getElementById('customerDetailsContent').innerHTML = detailsHtml;
    document.getElementById('customerDetailsModal').classList.remove('hidden');
    console.log('‚úÖ Modal d√©tails ouverte');
    
    } catch (error) {
      console.error('‚ùå Erreur lors du chargement des d√©tails:', error);
      alert('Erreur lors du chargement des d√©tails du client: ' + error.message);
    }
  }

  function closeDetailsModal() {
    document.getElementById('customerDetailsModal').classList.add('hidden');
  }

  // Event delegation pour les boutons des clients
  document.getElementById('customersList').addEventListener('click', function(e) {
    const viewBtn = e.target.closest('.view-customer-btn');
    if (viewBtn) {
      console.log('üñ±Ô∏è Clic d√©tect√© sur bouton Voir d√©tails');
      const customerId = viewBtn.getAttribute('data-customer-id');
      console.log('üë§ ID client:', customerId);
      viewCustomer(customerId);
      return;
    }

    const editBtn = e.target.closest('.edit-customer-btn');
    if (editBtn) {
      console.log('üñ±Ô∏è Clic d√©tect√© sur bouton Modifier');
      const customerId = editBtn.getAttribute('data-customer-id');
      console.log('‚úèÔ∏è ID client:', customerId);
      editCustomer(customerId);
      return;
    }

    const deleteBtn = e.target.closest('.delete-customer-btn');
    if (deleteBtn) {
      console.log('üñ±Ô∏è Clic d√©tect√© sur bouton Supprimer');
      const customerId = deleteBtn.getAttribute('data-customer-id');
      const customerName = deleteBtn.getAttribute('data-customer-name');
      console.log('üóëÔ∏è ID client:', customerId, 'Nom:', customerName);
      deleteCustomer(customerId, customerName);
      return;
    }
  });

  // Charger au d√©marrage
  loadCustomers();
</script>

<%- include('partials/footer') %>
