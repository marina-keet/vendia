<%- include('partials/header') %>

<style>
  .currency-btn {
    background-color: transparent;
    color: #6b7280;
  }
  .currency-active {
    background-color: #3b82f6;
    color: white;
  }
  .currency-btn:hover:not(.currency-active) {
    background-color: #e5e7eb;
  }
  
  /* Styles pour les cartes produits modernes */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  /* Animation smooth pour le hover */
  #productsGrid > div {
    transform-origin: center;
  }
  
  /* Animation pour le changement de stock */
  @keyframes stockUpdate {
    0% { background-color: #fef3c7; transform: scale(1.05); }
    50% { background-color: #fde68a; }
    100% { background-color: transparent; transform: scale(1); }
  }
  
  .stock-updated {
    animation: stockUpdate 1.5s ease-in-out;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  
  .stock-pulse {
    animation: pulse 2s infinite;
  }
  
  /* Scrollbar personnalis√©e */
  #productsGrid::-webkit-scrollbar {
    width: 8px;
  }
  
  #productsGrid::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
  }
  
  #productsGrid::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 10px;
  }
  
  #productsGrid::-webkit-scrollbar-thumb:hover {
    background: #555;
  }
</style>

<div class="h-screen flex flex-col overflow-hidden bg-gray-100">
  <!-- En-t√™te fixe -->
  <div class="bg-blue-600 text-white px-6 py-3 shadow-lg flex-shrink-0">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold flex items-center">
        <i class="fas fa-cash-register mr-3"></i>Point de Vente
      </h1>
      <div class="flex items-center space-x-4">
        <!-- S√©lecteur de devise -->
        <div class="flex items-center space-x-2 bg-blue-700 rounded-lg p-1">
          <button onclick="setCurrency('FC')" id="btnFC" 
            class="px-4 py-1.5 rounded-md font-bold transition currency-btn currency-active text-sm">
            FC
          </button>
          <button onclick="setCurrency('USD')" id="btnUSD" 
            class="px-4 py-1.5 rounded-md font-bold transition currency-btn text-sm">
            USD
          </button>
        </div>
        <div class="text-right">
          <div class="text-xs opacity-75">Caissier</div>
          <div class="font-bold" id="cashierName">Chargement...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Corps principal avec split 65/35 -->
  <div class="flex-1 flex overflow-hidden">
    <!-- Zone produits - 65% GAUCHE -->
    <div class="w-[65%] flex flex-col bg-white border-r-4 border-gray-200">
      <!-- Barre de recherche -->
      <div class="p-4 border-b-2 border-gray-200 flex-shrink-0">
        <div class="relative">
          <input type="text" id="productSearch" placeholder="üîç Scanner ou rechercher un produit (Nom, Code-barres)..." 
            oninput="filterProducts()"
            class="w-full border-2 border-blue-500 rounded-lg px-4 py-3 text-lg focus:ring-2 focus:ring-blue-600 focus:border-blue-600 shadow-sm font-medium"
            autofocus>
          <div class="absolute right-4 top-1/2 transform -translate-y-1/2">
            <i class="fas fa-barcode text-blue-500 text-xl"></i>
          </div>
        </div>
      </div>

      <!-- Grille de produits scrollable -->
      <div class="flex-1 overflow-y-auto p-4">
        <div id="productsGrid" class="grid grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 2xl:grid-cols-8 gap-2.5">
          <div class="text-center text-gray-500 col-span-full py-12">
            <i class="fas fa-spinner fa-spin text-4xl mb-4 text-blue-600"></i>
            <p class="text-lg">Chargement des produits...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Zone panier - 35% DROITE -->
    <div class="w-[35%] flex flex-col bg-gradient-to-br from-gray-50 to-blue-50">
      <!-- En-t√™te panier -->
      <div class="bg-white border-b-2 border-blue-200 p-4 flex-shrink-0">
        <div class="flex justify-between items-center">
          <div>
            <h2 class="text-xl font-bold text-gray-800 flex items-center">
              <i class="fas fa-shopping-cart text-blue-600 mr-2"></i>
              Panier
            </h2>
            <span id="cartCount" class="text-sm text-gray-500 font-medium">(0 article)</span>
          </div>
          <button onclick="clearCart()" class="bg-red-100 text-red-600 hover:bg-red-200 px-4 py-2 rounded-lg transition font-semibold text-sm">
            <i class="fas fa-trash mr-1"></i>Vider
          </button>
        </div>
      </div>

      <!-- Liste articles panier -->
      <div class="flex-1 overflow-y-auto p-4">
        <div id="cartItems" class="space-y-2">
          <div class="text-center py-12 text-gray-400">
            <i class="fas fa-shopping-cart text-6xl mb-4"></i>
            <p class="text-base">Panier vide</p>
            <p class="text-sm">Scannez ou s√©lectionnez des produits</p>
          </div>
        </div>
      </div>

      <!-- Zone totaux et paiement -->
      <div class="flex-shrink-0 bg-white border-t-4 border-blue-200 p-4 space-y-3">
        <!-- Totaux -->
        <div class="space-y-2 pb-3 border-b-2 border-gray-200">
          <div class="flex justify-between text-lg">
            <span class="text-gray-600">Sous-total:</span>
            <span id="subtotal" class="font-bold text-gray-800">0 FC</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-600">Remise:</span>
            <input type="number" id="discount" value="0" min="0" 
              class="w-28 border-2 rounded-lg px-3 py-1.5 text-right font-bold focus:ring-2 focus:ring-blue-500"
              onchange="updateTotal()">
          </div>
        </div>

        <!-- Total principal -->
        <div class="flex justify-between text-2xl font-bold text-white bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl p-4 shadow-lg">
          <span>TOTAL:</span>
          <span id="total">0 FC</span>
        </div>
        
        <div class="flex justify-between text-sm text-gray-500">
          <span>√âquivalent:</span>
          <span id="totalSecondary" class="font-medium">0 $</span>
        </div>

        <!-- Argent re√ßu -->
        <div class="bg-gradient-to-br from-green-50 to-emerald-100 p-4 rounded-xl border-2 border-green-300">
          <div class="flex justify-between items-center mb-2">
            <label class="font-bold text-gray-700 text-sm">
              <i class="fas fa-money-bill-wave text-green-600 mr-2"></i>Argent re√ßu:
            </label>
            <input type="number" id="cashReceived" value="0" min="0" step="0.01"
              class="w-36 border-2 border-green-400 rounded-lg px-3 py-2 text-right font-bold text-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white"
              oninput="calculateChange()"
              placeholder="0">
          </div>

          <div id="changeDisplay" class="hidden mt-3 pt-3 border-t-2 border-green-300">
            <div class="flex justify-between text-lg font-bold" id="changeContainer">
              <span class="text-gray-700">
                <i class="fas fa-hand-holding-usd mr-2 text-green-600"></i>Monnaie:
              </span>
              <span id="changeAmount" class="text-green-700">0 FC</span>
            </div>
          </div>
        </div>

        <!-- Client et m√©thode de paiement -->
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-bold text-gray-700 mb-1">
              <i class="fas fa-user mr-1 text-blue-600"></i>Client
            </label>
            <select id="customerId" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 bg-white">
              <option value="">Sans client</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-bold text-gray-700 mb-1">
              <i class="fas fa-credit-card mr-1 text-blue-600"></i>Paiement
            </label>
            <select id="paymentMethod" class="w-full border-2 border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 bg-white">
              <option value="cash">üíµ Esp√®ces</option>
            </select>
          </div>
        </div>

        <!-- Bouton validation -->
        <button onclick="completeSale()" 
          class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-4 rounded-xl hover:from-green-700 hover:to-green-800 transition text-xl font-bold shadow-lg transform hover:scale-[1.02] active:scale-[0.98]">
          <i class="fas fa-check-circle mr-2"></i>VALIDER LA VENTE
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmation avec aper√ßu du re√ßu -->
<div id="successModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
  <div class="bg-white rounded-lg max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
    <!-- En-t√™te -->
    <div class="bg-green-600 text-white p-6 text-center">
      <div class="text-6xl mb-4">
        <i class="fas fa-check-circle"></i>
      </div>
      <h2 class="text-2xl font-bold">Vente r√©ussie!</h2>
      <p class="text-green-100">La vente a √©t√© enregistr√©e avec succ√®s.</p>
    </div>
    
    <!-- Aper√ßu du re√ßu -->
    <div id="receiptPreview" class="p-6">
      <div class="text-center text-gray-500">
        <i class="fas fa-spinner fa-spin text-2xl"></i>
        <p class="mt-2">Chargement du re√ßu...</p>
      </div>
    </div>
    
    <!-- Actions -->
    <div class="p-6 border-t space-y-3">
      <button onclick="printReceipt()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-semibold">
        <i class="fas fa-print mr-2"></i>Imprimer le re√ßu
      </button>
      <button onclick="downloadReceipt()" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 font-semibold">
        <i class="fas fa-download mr-2"></i>T√©l√©charger PDF
      </button>
      <button onclick="closeSuccessModal()" class="w-full bg-gray-200 text-gray-800 py-3 rounded-lg hover:bg-gray-300 font-semibold">
        <i class="fas fa-plus mr-2"></i>Nouvelle vente
      </button>
    </div>
  </div>
</div>

<script>
  let products = [];
  let previousStocks = {}; // Suivre les anciens stocks
  let cart = [];
  let lastSaleId = null;
  let customers = [];
  let currentCurrency = 'FC'; // Devise actuelle
  let exchangeRate = 2500; // Taux de change par d√©faut
  let currencySettings = null;

  // Charger les param√®tres de devise
  async function loadCurrencySettings() {
    try {
      const response = await fetch('/api/settings/currency/info');
      currencySettings = await response.json();
      currentCurrency = currencySettings.primaryCurrency;
      exchangeRate = currencySettings.exchangeRate;
      
      // Activer le bouton de la devise par d√©faut
      setCurrency(currentCurrency);
    } catch (error) {
      console.error('Erreur chargement devises:', error);
    }
  }

  // Changer de devise
  function setCurrency(currency) {
    currentCurrency = currency;
    
    // Mettre √† jour les boutons
    document.querySelectorAll('.currency-btn').forEach(btn => {
      btn.classList.remove('currency-active');
    });
    document.getElementById(`btn${currency}`).classList.add('currency-active');
    
    // Rafra√Æchir l'affichage
    displayProducts(products);
    displayCart();
    updateTotal();
  }

  // Formater un montant avec la devise
  function formatCurrency(amount, currency = currentCurrency) {
    const formatted = new Intl.NumberFormat('fr-CD', {
      minimumFractionDigits: 0,
      maximumFractionDigits: 2
    }).format(amount);
    
    return currency === 'FC' ? `${formatted} FC` : `${formatted} $`;
  }

  // Convertir un montant
  function convertAmount(amount, from, to) {
    if (from === to) return amount;
    if (from === 'FC' && to === 'USD') return amount / exchangeRate;
    if (from === 'USD' && to === 'FC') return amount * exchangeRate;
    return amount;
  }

  // Charger les produits et clients
  async function loadProducts() {
    try {
      console.log('üîÑ Chargement des produits POS...');
      const response = await apiRequest('/api/products/pos-list');
      const data = await response.json();
      console.log('üì¶ Donn√©es re√ßues:', data);
      
      // Sauvegarder les anciens stocks avant de mettre √† jour
      const oldStocks = {};
      products.forEach(p => {
        oldStocks[p._id || p.id] = p.stock;
      });
      
      // Filtrer pour ne garder que les produits en stock
      products = (data.products || []).filter(p => p.stock > 0);
      console.log('‚úÖ Produits en stock:', products.length);
      
      // D√©tecter les changements de stock
      products.forEach(p => {
        const productId = p._id || p.id;
        const oldStock = oldStocks[productId];
        if (oldStock !== undefined && oldStock !== p.stock) {
          previousStocks[productId] = {
            old: oldStock,
            new: p.stock,
            changed: true
          };
          console.log(`üìâ Stock mis √† jour pour ${p.name}: ${oldStock} ‚Üí ${p.stock}`);
        }
      });
      
      displayProducts(); // Afficher sans filtre
    } catch (error) {
      console.error('‚ùå Erreur chargement produits:', error);
      document.getElementById('productsGrid').innerHTML = '<p class="text-red-500 text-center col-span-full py-8">Erreur de chargement des produits. Veuillez rafra√Æchir la page.</p>';
    }
  }

  async function loadCustomers() {
    try {
      const response = await apiRequest('/api/customers');
      customers = await response.json();
      
      const select = document.getElementById('customerId');
      customers.forEach(c => {
        const option = document.createElement('option');
        option.value = c.id;
        option.textContent = `${c.name} - ${c.phone}`;
        select.appendChild(option);
      });
    } catch (error) {
      console.error('Erreur chargement clients:', error);
    }
  }

  // Filtrer les produits lors de la recherche
  function filterProducts() {
    const searchTerm = document.getElementById('productSearch').value.toLowerCase();
    displayProducts(searchTerm);
  }

  // Afficher les produits avec filtre optionnel
  function displayProducts(filter = '') {
    const grid = document.getElementById('productsGrid');
    let productList = products;
    
    if (filter) {
      productList = products.filter(p => 
        p.name.toLowerCase().includes(filter) || 
        p.barcode?.toLowerCase().includes(filter)
      );
      
      // Si recherche et aucun r√©sultat
      if (productList.length === 0) {
        grid.innerHTML = `
          <div class="col-span-full text-center py-12">
            <div class="bg-red-50 border-2 border-red-300 rounded-xl p-8 inline-block">
              <i class="fas fa-box-open text-6xl text-red-400 mb-4"></i>
              <h3 class="text-xl font-bold text-red-800 mb-2">Produit non disponible</h3>
              <p class="text-red-600 mb-3">Le produit recherch√© est en <strong>rupture de stock</strong></p>
              <p class="text-sm text-red-500">
                <i class="fas fa-exclamation-triangle mr-1"></i>
                Veuillez <strong>r√©approvisionner</strong> ou contacter le fournisseur
              </p>
            </div>
          </div>
        `;
        return;
      }
    }
    
    if (productList.length === 0) {
      grid.innerHTML = `
        <div class="col-span-full text-center py-12">
          <div class="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-8 inline-block">
            <i class="fas fa-exclamation-circle text-6xl text-yellow-500 mb-4"></i>
            <h3 class="text-xl font-bold text-yellow-800 mb-2">Aucun produit disponible</h3>
            <p class="text-yellow-600">Tous les produits sont en rupture de stock</p>
          </div>
        </div>
      `;
      return;
    }
    
    grid.innerHTML = productList.map(p => {
      // Prix par d√©faut en FC, convertir si n√©cessaire
      const priceInCurrentCurrency = currentCurrency === 'USD' 
        ? convertAmount(p.price, 'FC', 'USD')
        : p.price;
      
      const productId = p._id || p.id;
      
      // D√©terminer la couleur de fond selon le stock
      let stockBgClass = 'bg-green-50 border-green-200';
      let stockTextClass = 'text-green-700';
      let stockIcon = 'fa-check-circle';
      let stockStatus = 'En stock';
      
      if (p.stock === 0) {
        stockBgClass = 'bg-red-50 border-red-300';
        stockTextClass = 'text-red-700';
        stockIcon = 'fa-times-circle';
        stockStatus = 'Rupture';
      } else if (p.stock <= 10) {
        stockBgClass = 'bg-yellow-50 border-yellow-300';
        stockTextClass = 'text-yellow-700';
        stockIcon = 'fa-exclamation-triangle';
        stockStatus = 'Stock faible';
      }
      
      // V√©rifier si le stock a chang√©
      const stockChange = previousStocks[productId];
      let stockChangeHtml = '';
      let cardAnimation = '';
      
      if (stockChange && stockChange.changed) {
        const diff = stockChange.new - stockChange.old;
        if (diff < 0) {
          stockChangeHtml = `
            <div class="absolute top-2 left-2 bg-red-500 text-white px-2 py-1 rounded-full text-xs font-bold animate-bounce">
              ${diff} <i class="fas fa-arrow-down"></i>
            </div>
          `;
          cardAnimation = 'stock-updated';
        }
        // Nettoyer apr√®s l'affichage
        setTimeout(() => {
          delete previousStocks[productId];
        }, 3000);
      }
      
      return `
      <div onclick="addToCart('${productId}')" 
        class="relative border-2 ${stockBgClass} rounded-lg p-3 hover:shadow-lg hover:scale-[1.02] cursor-pointer transition-all duration-150 ${p.stock === 0 ? 'opacity-50 cursor-not-allowed' : ''} ${cardAnimation} flex flex-col h-full">
        
        ${stockChangeHtml}
        
        <!-- Badge Prix en haut √† droite -->
        <div class="absolute top-1 right-1 bg-blue-600 text-white px-2 py-1 rounded-md text-xs font-bold shadow">
          ${formatCurrency(priceInCurrentCurrency)}
        </div>
        
        <!-- Ic√¥ne Produit centr√© -->
        <div class="flex-1 flex items-center justify-center py-2">
          <div class="bg-blue-100 rounded-lg w-14 h-14 flex items-center justify-center">
            <i class="fas fa-box text-2xl text-blue-600"></i>
          </div>
        </div>
        
        <!-- Nom du produit -->
        <div class="text-center mb-2">
          <h3 class="font-bold text-gray-800 text-sm leading-tight line-clamp-2 min-h-[2.5rem]">${p.name}</h3>
        </div>
        
        <!-- Badge Stock en bas -->
        <div class="text-center pb-1">
          <div class="inline-flex items-center space-x-1 ${stockTextClass} text-xs font-semibold px-2 py-1 rounded ${stockBgClass} ${stockChange && stockChange.changed ? 'stock-pulse' : ''}">
            <i class="fas ${stockIcon} text-xs"></i>
            <span>${p.stock}</span>
          </div>
          ${stockChange && stockChange.changed ? `
            <div class="text-xs text-gray-400 mt-0.5">
              (${stockChange.old})
            </div>
          ` : ''}
        </div>
      </div>
    `}).join('');
  }

  // Ajouter au panier
  function addToCart(productId) {
    const product = products.find(p => (p._id || p.id) === productId);
    
    if (!product || product.stock === 0) {
      Swal.fire({
        icon: 'error',
        title: 'Produit indisponible',
        html: `
          <p class="text-red-600 mb-2">Ce produit est en <strong>rupture de stock</strong></p>
          <p class="text-sm text-gray-600">Veuillez r√©approvisionner pour continuer la vente</p>
        `,
        confirmButtonColor: '#dc2626'
      });
      return;
    }
    
    const cartItem = cart.find(item => item.productId === productId);
    
    if (cartItem) {
      if (cartItem.quantity < product.stock) {
        cartItem.quantity++;
      } else {
        alert('Stock insuffisant');
        return;
      }
    } else {
      cart.push({
        productId: product._id || product.id,
        productName: product.name,
        unitPrice: product.price,
        quantity: 1
      });
    }
    
    displayCart();
    updateTotal();
  }

  // Afficher le panier
  function displayCart() {
    const container = document.getElementById('cartItems');
    const countElement = document.getElementById('cartCount');
    
    // Mettre √† jour le compteur
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    countElement.textContent = `(${totalItems} article${totalItems > 1 ? 's' : ''})`;
    
    if (cart.length === 0) {
      container.innerHTML = `
        <div class="text-center py-12 text-gray-400">
          <i class="fas fa-shopping-cart text-6xl mb-4"></i>
          <p class="text-base">Panier vide</p>
          <p class="text-sm">Scannez ou s√©lectionnez des produits</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = cart.map((item, index) => {
      const priceInCurrentCurrency = currentCurrency === 'USD' 
        ? convertAmount(item.unitPrice, 'FC', 'USD')
        : item.unitPrice;
      
      const subtotal = priceInCurrentCurrency * item.quantity;
      
      return `
      <div class="bg-white p-2.5 rounded-lg shadow-sm border border-gray-200 hover:border-blue-300 transition">
        <div class="flex items-center gap-3">
          <!-- Quantit√© avec contr√¥les -->
          <div class="flex flex-col items-center bg-gray-50 rounded-lg px-2 py-1 border border-gray-200">
            <input 
              type="number" 
              value="${item.quantity}" 
              min="1" 
              max="999"
              onchange="setQuantity(${index}, this.value)"
              onclick="event.stopPropagation()"
              class="w-14 text-center border-0 bg-transparent font-bold text-base focus:ring-0 p-0"
            >
            <div class="text-xs text-gray-400 font-medium">qt√©</div>
          </div>
          
          <!-- Infos produit -->
          <div class="flex-1 min-w-0">
            <div class="font-bold text-gray-800 text-sm truncate">${item.productName}</div>
            <div class="text-xs text-gray-500">${formatCurrency(priceInCurrentCurrency)}/u</div>
          </div>
          
          <!-- Prix total -->
          <div class="text-right">
            <div class="font-bold text-blue-600 text-sm">${formatCurrency(subtotal)}</div>
          </div>
          
          <!-- Bouton supprimer -->
          <button onclick="removeFromCart(${index})" class="text-red-400 hover:text-red-600 hover:bg-red-50 rounded-full p-1.5 transition">
            <i class="fas fa-times text-sm"></i>
          </button>
        </div>
      </div>
    `}).join('');
  }

  // D√©finir la quantit√© directement
  function setQuantity(index, value) {
    const item = cart[index];
    const product = products.find(p => (p._id || p.id) === item.productId);
    
    const newQuantity = parseInt(value) || 1;
    
    if (newQuantity <= 0) {
      removeFromCart(index);
    } else if (product && newQuantity <= product.stock) {
      item.quantity = newQuantity;
      displayCart();
      updateTotal();
    } else {
      alert(`Stock insuffisant. Maximum disponible: ${product.stock}`);
      displayCart(); // R√©afficher avec l'ancienne valeur
    }
  }

  // Mettre √† jour la quantit√© (pour compatibilit√©)
  function updateQuantity(index, change) {
    const item = cart[index];
    setQuantity(index, item.quantity + change);
  }

  // Retirer du panier
  function removeFromCart(index) {
    cart.splice(index, 1);
    displayCart();
    updateTotal();
  }

  // Vider le panier
  function clearCart() {
    if (cart.length > 0 && confirm('Vider le panier?')) {
      cart = [];
      document.getElementById('cashReceived').value = 0;
      displayCart();
      updateTotal();
    }
  }

  // Mettre √† jour le total
  function updateTotal() {
    const subtotal = cart.reduce((sum, item) => sum + (item.unitPrice * item.quantity), 0);
    const discount = parseFloat(document.getElementById('discount').value) || 0;
    const total = Math.max(0, subtotal - discount);
    
    // Affichage dans la devise actuelle
    const subtotalInCurrentCurrency = currentCurrency === 'USD' 
      ? convertAmount(subtotal, 'FC', 'USD')
      : subtotal;
    const totalInCurrentCurrency = currentCurrency === 'USD' 
      ? convertAmount(total, 'FC', 'USD')
      : total;
    
    // Affichage dans la devise secondaire
    const secondaryCurrency = currentCurrency === 'FC' ? 'USD' : 'FC';
    const totalInSecondary = convertAmount(total, 'FC', secondaryCurrency);
    
    document.getElementById('subtotal').textContent = formatCurrency(subtotalInCurrentCurrency);
    document.getElementById('total').textContent = formatCurrency(totalInCurrentCurrency);
    document.getElementById('totalSecondary').textContent = formatCurrency(totalInSecondary, secondaryCurrency);
    
    // Recalculer la monnaie apr√®s mise √† jour du total
    calculateChange();
  }

  // Calculer la monnaie √† rendre
  function calculateChange() {
    const subtotal = cart.reduce((sum, item) => sum + (item.unitPrice * item.quantity), 0);
    const discount = parseFloat(document.getElementById('discount').value) || 0;
    const total = Math.max(0, subtotal - discount);
    
    // Convertir le total dans la devise actuelle
    const totalInCurrentCurrency = currentCurrency === 'USD' 
      ? convertAmount(total, 'FC', 'USD')
      : total;
    
    const cashReceived = parseFloat(document.getElementById('cashReceived').value) || 0;
    const change = cashReceived - totalInCurrentCurrency;
    
    const changeDisplay = document.getElementById('changeDisplay');
    const changeContainer = document.getElementById('changeContainer');
    const changeAmount = document.getElementById('changeAmount');
    
    if (cashReceived > 0 && total > 0) {
      changeDisplay.classList.remove('hidden');
      
      if (change >= 0) {
        // Monnaie positive - √† rendre au client
        changeContainer.className = 'flex justify-between text-lg font-bold p-3 rounded-lg bg-gradient-to-r from-green-500 to-green-600 text-white shadow-lg';
        changeContainer.innerHTML = `
          <span>
            <i class="fas fa-hand-holding-usd mr-2"></i>Monnaie √† rendre:
          </span>
          <span>${formatCurrency(change)}</span>
        `;
      } else {
        // Argent insuffisant
        changeContainer.className = 'flex justify-between text-lg font-bold p-3 rounded-lg bg-gradient-to-r from-red-500 to-red-600 text-white shadow-lg';
        changeContainer.innerHTML = `
          <span>
            <i class="fas fa-exclamation-triangle mr-2"></i>Manquant:
          </span>
          <span>${formatCurrency(Math.abs(change))}</span>
        `;
      }
    } else {
      changeDisplay.classList.add('hidden');
    }
  }

  // Finaliser la vente
  async function completeSale() {
    if (cart.length === 0) {
      alert('Le panier est vide');
      return;
    }
    
    const paymentMethod = document.getElementById('paymentMethod').value;
    const discount = parseFloat(document.getElementById('discount').value) || 0;
    const customerId = document.getElementById('customerId').value || null;
    
    // R√©cup√©rer le nom du client
    let customerName = 'Client anonyme';
    if (customerId) {
      const selectedOption = document.getElementById('customerId').selectedOptions[0];
      customerName = selectedOption ? selectedOption.textContent : 'Client anonyme';
    }
    
    const saleData = {
      items: cart,
      paymentMethod: paymentMethod,
      discount: discount,
      customerId: customerId ? parseInt(customerId) : null,
      customerName: customerName
    };
    
    try {
      const response = await apiRequest('/api/sales', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(saleData)
      });
      
      const result = await response.json();
      
      if (response.ok) {
        lastSaleId = result.saleId;
        document.getElementById('successModal').classList.remove('hidden');
        loadReceiptPreview(result.saleId);
        cart = [];
        document.getElementById('discount').value = 0;
        document.getElementById('customerId').value = '';
        displayCart();
        updateTotal();
        loadProducts(); // Rafra√Æchir les stocks
      } else {
        alert('Erreur: ' + result.error);
      }
    } catch (error) {
      alert('Erreur lors de l\'enregistrement de la vente');
    }
  }

  // Charger l'aper√ßu du re√ßu
  async function loadReceiptPreview(saleId) {
    try {
      const response = await apiRequest(`/api/sales/${saleId}`);
      const data = await response.json();
      const sale = data.sale;
      const items = data.items;
      const customerName = data.customerName || 'Client anonyme';
      const cashierName = data.cashierName || 'N/A';
      
      // Charger les param√®tres de devise
      const settingsResponse = await fetch('/api/settings');
      const settingsData = await settingsResponse.json();
      const currency = settingsData.settings?.primaryCurrency || 'FC';
      const currencySymbol = currency === 'USD' ? '$' : 'FC';
      
      // Fonction pour formater la devise
      const formatCurrency = (amount) => {
        const formatted = new Intl.NumberFormat('fr-FR').format(Math.round(amount));
        return `${formatted} ${currencySymbol}`;
      };
      
      // Construire le HTML des articles
      let itemsHtml = '';
      items.forEach(item => {
        itemsHtml += `
          <tr class="border-b">
            <td class="py-2">${item.product_name}</td>
            <td class="py-2 text-center">${item.quantity}</td>
            <td class="py-2 text-right">${formatCurrency(item.unit_price)}</td>
            <td class="py-2 text-right font-semibold">${formatCurrency(item.subtotal)}</td>
          </tr>
        `;
      });
      
      const preview = `
        <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6">
          <!-- En-t√™te -->
          <div class="text-center border-b pb-4 mb-4">
            <h3 class="text-2xl font-bold text-gray-800">VENDIA Commerce</h3>
            <p class="text-sm text-gray-600">Kinshasa, RDC</p>
            <p class="text-sm text-gray-600">+243 XXX XXX XXX</p>
          </div>
          
          <!-- Informations de la facture -->
          <div class="grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded mb-4">
            <div>
              <p class="text-sm text-gray-600">Num√©ro de facture</p>
              <p class="font-semibold">#${sale.id}</p>
            </div>
            <div>
              <p class="text-sm text-gray-600">Date</p>
              <p class="font-semibold">${new Date(sale.created_at).toLocaleString('fr-FR')}</p>
            </div>
            <div>
              <p class="text-sm text-gray-600">Client</p>
              <p class="font-semibold">${customerName}</p>
            </div>
            <div>
              <p class="text-sm text-gray-600">Caissier</p>
              <p class="font-semibold">${cashierName}</p>
            </div>
          </div>
          
          <!-- Articles -->
          <div class="mb-4">
            <h4 class="font-semibold mb-2 text-gray-700">Articles</h4>
            <table class="w-full">
              <thead class="bg-gray-100">
                <tr>
                  <th class="py-2 px-2 text-left text-sm">Article</th>
                  <th class="py-2 px-2 text-center text-sm">Qt√©</th>
                  <th class="py-2 px-2 text-right text-sm">Prix unit.</th>
                  <th class="py-2 px-2 text-right text-sm">Total</th>
                </tr>
              </thead>
              <tbody>
                ${itemsHtml}
              </tbody>
            </table>
          </div>
          
          <!-- Totaux -->
          <div class="border-t pt-4 space-y-2">
            <div class="flex justify-between">
              <span class="text-gray-700">Sous-total:</span>
              <span class="font-semibold">${formatCurrency(sale.total_amount)}</span>
            </div>
            ${sale.discount > 0 ? `
            <div class="flex justify-between text-red-600">
              <span>Remise:</span>
              <span class="font-semibold">-${formatCurrency(sale.discount)}</span>
            </div>
            ` : ''}
            <div class="flex justify-between text-xl font-bold border-t pt-2 mt-2">
              <span class="text-gray-800">TOTAL:</span>
              <span class="text-green-600">${formatCurrency(sale.final_amount)}</span>
            </div>
          </div>
          
          <!-- Pied de page -->
          <div class="text-center mt-6 pt-4 border-t">
            <p class="text-gray-600">Mode de paiement: <span class="font-semibold">${getPaymentMethodLabel(sale.payment_method)}</span></p>
            <p class="text-sm text-gray-500 mt-2">Merci de votre visite !</p>
          </div>
        </div>
      `;
      
      document.getElementById('receiptPreview').innerHTML = preview;
    } catch (error) {
      console.error('Erreur chargement re√ßu:', error);
      document.getElementById('receiptPreview').innerHTML = `
        <div class="text-center text-red-600">
          <i class="fas fa-exclamation-circle text-2xl"></i>
          <p class="mt-2">Erreur de chargement du re√ßu</p>
        </div>
      `;
    }
  }

  // Libell√©s des m√©thodes de paiement
  function getPaymentMethodLabel(method) {
    const labels = {
      'cash': 'Esp√®ces',
      'card': 'Carte bancaire',
      'mobile_money': 'Mobile Money',
      'other': 'Autre'
    };
    return labels[method] || method;
  }

  // Imprimer le re√ßu
  async function printReceipt() {
    if (!lastSaleId) return;
    
    try {
      // R√©cup√©rer les donn√©es de la vente
      const response = await apiRequest(`/api/sales/${lastSaleId}`);
      const data = await response.json();
      const sale = data.sale;
      const items = data.items;
      const customerName = data.customerName || 'Client anonyme';
      const cashierName = data.cashierName || 'N/A';
      
      const settingsResponse = await fetch('/api/settings/currency/info');
      const currencyInfo = await settingsResponse.json();
      
      // Calculer totaux
      const totalFC = sale.final_amount;
      const totalUSD = totalFC / currencyInfo.exchangeRate;
      
      // Cr√©er une fen√™tre d'impression
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>Facture N¬∞ ${sale.id}</title>
          <style>
            @page {
              size: 80mm auto;
              margin: 5mm;
            }
            * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
            }
            body {
              font-family: 'Courier New', monospace;
              font-size: 12px;
              line-height: 1.4;
              max-width: 80mm;
              margin: 0 auto;
              padding: 10px;
            }
            .center {
              text-align: center;
            }
            .bold {
              font-weight: bold;
            }
            .header {
              text-align: center;
              margin-bottom: 15px;
              border-bottom: 2px dashed #000;
              padding-bottom: 10px;
            }
            .header h1 {
              font-size: 18px;
              margin-bottom: 5px;
            }
            .info {
              margin: 10px 0;
              padding: 10px 0;
              border-bottom: 1px dashed #000;
            }
            .info-line {
              display: flex;
              justify-content: space-between;
              margin: 3px 0;
            }
            .items {
              margin: 10px 0;
            }
            .items table {
              width: 100%;
              border-collapse: collapse;
            }
            .items th {
              text-align: left;
              border-bottom: 1px solid #000;
              padding: 5px 0;
            }
            .items td {
              padding: 5px 0;
            }
            .items .right {
              text-align: right;
            }
            .totals {
              margin-top: 10px;
              padding-top: 10px;
              border-top: 1px dashed #000;
            }
            .total-line {
              display: flex;
              justify-content: space-between;
              margin: 5px 0;
            }
            .total-line.final {
              font-size: 14px;
              font-weight: bold;
              border-top: 2px solid #000;
              padding-top: 5px;
              margin-top: 5px;
            }
            .footer {
              text-align: center;
              margin-top: 15px;
              padding-top: 10px;
              border-top: 1px dashed #000;
              font-size: 11px;
            }
            @media print {
              body {
                margin: 0;
                padding: 5mm;
              }
            }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>Mon Commerce</h1>
            <div>Kinshasa, RDC</div>
            <div>+243 XX XX XX XX</div>
          </div>
          
          <div class="info">
            <div class="info-line">
              <span class="bold">N¬∞ de Facture:</span>
              <span>${sale.id}</span>
            </div>
            <div class="info-line">
              <span class="bold">Date:</span>
              <span>${new Date(sale.created_at).toLocaleString('fr-FR')}</span>
            </div>
            <div class="info-line">
              <span class="bold">Client:</span>
              <span>${customerName}</span>
            </div>
            <div class="info-line">
              <span class="bold">Caissier:</span>
              <span>${cashierName}</span>
            </div>
          </div>
          
          <div class="items">
            <table>
              <thead>
                <tr>
                  <th>Article</th>
                  <th class="right">Qt√©</th>
                  <th class="right">P.U.</th>
                  <th class="right">Total</th>
                </tr>
              </thead>
              <tbody>
                ${items.map(item => `
                  <tr>
                    <td>${item.product_name}</td>
                    <td class="right">${item.quantity}</td>
                    <td class="right">${Math.round(item.unit_price)} FC</td>
                    <td class="right">${Math.round(item.subtotal)} FC</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          
          <div class="totals">
            <div class="total-line">
              <span>Sous-total:</span>
              <span>${Math.round(sale.total_amount)} FC</span>
            </div>
            ${sale.discount > 0 ? `
            <div class="total-line">
              <span>Remise:</span>
              <span>-${Math.round(sale.discount)} FC</span>
            </div>
            ` : ''}
            <div class="total-line final">
              <span>TOTAL:</span>
              <span>${Math.round(totalFC)} FC</span>
            </div>
            <div class="total-line">
              <span>√âquivalent:</span>
              <span>${totalUSD.toFixed(2)} $</span>
            </div>
          </div>
          
          <div class="footer">
            <p class="bold">Merci de votre visite !</p>
            <p>Paiement: ${getPaymentMethodLabel(sale.payment_method)}</p>
            <p style="margin-top: 10px; font-size: 10px;">
              Imprim√© le ${new Date().toLocaleString('fr-FR')}
            </p>
          </div>
          
          <sc`+`ript>
            // Attendre que le contenu soit charg√© puis lancer l'impression
            window.onload = function() {
              setTimeout(function() {
                window.print();
                // Fermer la fen√™tre apr√®s impression (optionnel)
                // window.onafterprint = function() { window.close(); }
              }, 250);
            }
          </sc`+`ript>
        </body>
        </html>
      `);
      printWindow.document.close();
      
    } catch (error) {
      console.error('Erreur impression:', error);
      alert('Erreur lors de la pr√©paration de l\'impression');
    }
  }

  // T√©l√©charger le re√ßu PDF
  function downloadReceipt() {
    if (lastSaleId) {
      window.open(`/api/sales/${lastSaleId}/receipt`, '_blank');
    }
  }

  // Fermer le modal de succ√®s
  function closeSuccessModal() {
    document.getElementById('successModal').classList.add('hidden');
    lastSaleId = null;
  }

  // Recherche de produits
  document.getElementById('productSearch').addEventListener('input', (e) => {
    const search = e.target.value.toLowerCase();
    const filtered = products.filter(p => 
      p.name.toLowerCase().includes(search) || 
      (p.barcode && p.barcode.includes(search))
    );
    displayProducts(filtered);
  });

  // Recherche par code-barres (Enter)
  document.getElementById('productSearch').addEventListener('keypress', async (e) => {
    if (e.key === 'Enter') {
      const barcode = e.target.value.trim();
      const response = await apiRequest(`/api/products/search/barcode/${barcode}`);
      const data = await response.json();
      
      if (data.product) {
        addToCart(data.product.id);
        e.target.value = '';
      }
    }
  });

  // Charger au d√©marrage - attendre que le DOM soit pr√™t
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
  
  async function init() {
    try {
      console.log('üöÄ D√©marrage initialisation POS...');
      console.log('üìç apiRequest disponible:', typeof window.apiRequest);
      console.log('üìç productsGrid existe:', !!document.getElementById('productsGrid'));
      
      // Charger le nom du caissier depuis le header
      const userElement = document.querySelector('[data-user-name]');
      if (userElement) {
        const userName = userElement.getAttribute('data-user-name');
        document.getElementById('cashierName').textContent = userName;
      }
      
      await loadCurrencySettings();
      await loadProducts();
      await loadCustomers();
      console.log('‚úÖ Initialisation POS termin√©e');
    } catch (error) {
      console.error('‚ùå Erreur initialisation POS:', error);
      alert('Erreur lors du chargement du POS. Veuillez actualiser la page.');
    }
  }
</script>

<%- include('partials/footer') %>
