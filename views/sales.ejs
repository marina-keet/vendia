<%- include('partials/header') %>

<div class="container mx-auto px-4 py-8">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-800">
      <i class="fas fa-receipt text-blue-600 mr-2"></i>Historique des Ventes
    </h1>
  </div>

  <!-- Filtres -->
  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Date début</label>
        <input type="date" id="startDate" class="w-full border rounded-lg px-4 py-2">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Date fin</label>
        <input type="date" id="endDate" class="w-full border rounded-lg px-4 py-2">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Paiement</label>
        <select id="paymentFilter" class="w-full border rounded-lg px-4 py-2">
          <option value="">Tous</option>
          <option value="cash">Espèces</option>
        </select>
      </div>
      <div class="flex items-end">
        <button onclick="loadSales()" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
          <i class="fas fa-filter mr-2"></i>Filtrer
        </button>
      </div>
    </div>
  </div>

  <!-- Carte total des ventes -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg shadow-lg p-6 text-white">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-semibold opacity-90">Montant Total Vendu</p>
          <p class="text-3xl font-bold mt-2" id="totalAmount">0 FC</p>
        </div>
        <div class="bg-white bg-opacity-20 rounded-full p-4">
          <i class="fas fa-coins text-4xl"></i>
        </div>
      </div>
    </div>

    <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-semibold opacity-90">Nombre de Ventes</p>
          <p class="text-3xl font-bold mt-2" id="totalSalesCount">0</p>
        </div>
        <div class="bg-white bg-opacity-20 rounded-full p-4">
          <i class="fas fa-shopping-cart text-4xl"></i>
        </div>
      </div>
    </div>

    <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg shadow-lg p-6 text-white">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-semibold opacity-90">Moyenne par Vente</p>
          <p class="text-3xl font-bold mt-2" id="averageAmount">0 FC</p>
        </div>
        <div class="bg-white bg-opacity-20 rounded-full p-4">
          <i class="fas fa-chart-line text-4xl"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Liste des ventes -->
  <div class="bg-white rounded-lg shadow-md overflow-hidden">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">N° Vente</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Client</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Articles</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Paiement</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Montant</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
        </tr>
      </thead>
      <tbody id="salesTable" class="bg-white divide-y divide-gray-200">
        <tr>
          <td colspan="7" class="px-6 py-4 text-center text-gray-500">Chargement...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="mt-6 flex justify-between items-center">
    <div class="text-sm text-gray-600">
      Total: <span id="totalSales" class="font-bold">0</span> ventes
    </div>
    <div class="flex space-x-2">
      <button onclick="prevPage()" class="px-4 py-2 border rounded hover:bg-gray-100">
        <i class="fas fa-chevron-left"></i>
      </button>
      <span class="px-4 py-2">Page <span id="currentPage">1</span></span>
      <button onclick="nextPage()" class="px-4 py-2 border rounded hover:bg-gray-100">
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>
</div>

<!-- Modal détails vente -->
<div id="saleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-start mb-6">
      <h2 class="text-2xl font-bold">Détails de la vente</h2>
      <button onclick="closeSaleModal()" class="text-gray-500 hover:text-gray-700">
        <i class="fas fa-times text-2xl"></i>
      </button>
    </div>

    <div id="saleDetails"></div>

    <div class="mt-6 flex justify-end space-x-4">
      <button onclick="printReceipt()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
        <i class="fas fa-print mr-2"></i>Imprimer
      </button>
      <button onclick="closeSaleModal()" class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-300">
        Fermer
      </button>
    </div>
  </div>
</div>

<script>
  let currentPage = 1;
  let totalPages = 1;
  let currentSaleId = null;
  let currentCurrency = 'FC';
  let currencySymbol = 'FC';

  // Charger la devise
  async function loadCurrencySettings() {
    try {
      const response = await fetch('/api/settings');
      const data = await response.json();
      if (data.settings && data.settings.primary_currency) {
        currentCurrency = data.settings.primary_currency;
        currencySymbol = currentCurrency === 'USD' ? '$' : 'FC';
      }
    } catch (error) {
      console.log('Utilisation de la devise par défaut: FC');
    }
  }

  function formatCurrency(amount) {
    const formatted = new Intl.NumberFormat('fr-FR').format(Math.round(amount));
    return `${formatted} ${currencySymbol}`;
  }

  async function loadSales(page = 1) {
    await loadCurrencySettings(); // Charger la devise d'abord
    
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const payment = document.getElementById('paymentFilter').value;
    
    let url = `/api/sales?limit=50&page=${page}`;
    if (startDate) url += `&startDate=${startDate}`;
    if (endDate) url += `&endDate=${endDate}`;
    if (payment) url += `&paymentMethod=${payment}`;
    
    const response = await apiRequest(url);
    const data = await response.json();
    
    displaySales(data.sales);
    updateStatistics(data.sales);
    currentPage = page;
    document.getElementById('currentPage').textContent = page;
  }

  function updateStatistics(sales) {
    // Calculer le montant total
    const totalAmount = sales.reduce((sum, sale) => sum + sale.final_amount, 0);
    const salesCount = sales.length;
    const averageAmount = salesCount > 0 ? totalAmount / salesCount : 0;

    // Mettre à jour les cartes
    document.getElementById('totalAmount').textContent = formatCurrency(totalAmount);
    document.getElementById('totalSalesCount').textContent = salesCount;
    document.getElementById('averageAmount').textContent = formatCurrency(averageAmount);
  }

  function displaySales(sales) {
    const tbody = document.getElementById('salesTable');
    
    if (sales.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Aucune vente trouvée</td></tr>';
      document.getElementById('totalSales').textContent = '0';
      updateStatistics([]);
      return;
    }
    
    document.getElementById('totalSales').textContent = sales.length;
    
    tbody.innerHTML = sales.map(s => `
      <tr class="hover:bg-gray-50">
        <td class="px-6 py-4 font-medium">#${s.id}</td>
        <td class="px-6 py-4">${new Date(s.created_at).toLocaleString('fr-FR')}</td>
        <td class="px-6 py-4">${s.customer_name || 'Client anonyme'}</td>
        <td class="px-6 py-4 text-sm text-gray-600">${s.notes || 'Vente courante'}</td>
        <td class="px-6 py-4">
          <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm">
            ${getPaymentLabel(s.payment_method)}
          </span>
        </td>
        <td class="px-6 py-4 font-bold">${formatCurrency(s.final_amount)}</td>
        <td class="px-6 py-4">
          <button onclick="viewSale(${s.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Voir détails">
            <i class="fas fa-eye"></i>
          </button>
          <a href="/api/sales/${s.id}/receipt" target="_blank" class="text-green-600 hover:text-green-800" title="Imprimer">
            <i class="fas fa-print"></i>
          </a>
        </td>
      </tr>
    `).join('');
  }

  async function viewSale(saleId) {
    currentSaleId = saleId;
    const response = await apiRequest(`/api/sales/${saleId}`);
    const data = await response.json();
    
    const detailsHtml = `
      <div class="space-y-4">
        <div class="bg-gray-50 p-4 rounded-lg">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <p class="text-sm text-gray-500">N° de vente</p>
              <p class="font-bold">#${data.sale.id}</p>
            </div>
            <div>
              <p class="text-sm text-gray-500">Date</p>
              <p class="font-bold">${new Date(data.sale.created_at).toLocaleString('fr-FR')}</p>
            </div>
            <div>
              <p class="text-sm text-gray-500">Paiement</p>
              <p class="font-bold">${getPaymentLabel(data.sale.payment_method)}</p>
            </div>
            <div>
              <p class="text-sm text-gray-500">Vendeur</p>
              <p class="font-bold">${data.sale.user_id ? 'ID #' + data.sale.user_id : 'Non enregistré'}</p>
            </div>
          </div>
        </div>

        <div>
          <h3 class="font-bold mb-3">Articles vendus</h3>
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Produit</th>
                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500">Qté</th>
                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">P.U.</th>
                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">Total</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              ${data.items.map(item => `
                <tr>
                  <td class="px-4 py-2">${item.product_name}</td>
                  <td class="px-4 py-2 text-center">${item.quantity}</td>
                  <td class="px-4 py-2 text-right">${formatCurrency(item.unit_price)}</td>
                  <td class="px-4 py-2 text-right font-bold">${formatCurrency(item.subtotal)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>

        <div class="bg-gray-50 p-4 rounded-lg">
          <div class="space-y-2">
            <div class="flex justify-between">
              <span>Sous-total:</span>
              <span class="font-bold">${formatCurrency(data.sale.total_amount)}</span>
            </div>
            ${data.sale.discount > 0 ? `
              <div class="flex justify-between text-red-600">
                <span>Remise:</span>
                <span class="font-bold">-${formatCurrency(data.sale.discount)}</span>
              </div>
            ` : ''}
            <div class="flex justify-between text-xl font-bold text-blue-600 border-t pt-2">
              <span>TOTAL:</span>
              <span>${formatCurrency(data.sale.final_amount)}</span>
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.getElementById('saleDetails').innerHTML = detailsHtml;
    document.getElementById('saleModal').classList.remove('hidden');
  }

  function closeSaleModal() {
    document.getElementById('saleModal').classList.add('hidden');
    currentSaleId = null;
  }

  function printReceipt() {
    if (currentSaleId) {
      window.open(`/api/sales/${currentSaleId}/receipt`, '_blank');
    }
  }

  function getPaymentLabel(method) {
    const labels = {
      'cash': 'Espèces',
      'card': 'Carte',
      'mobile_money': 'Mobile Money',
      'other': 'Autre'
    };
    return labels[method] || method;
  }

  function prevPage() {
    if (currentPage > 1) {
      loadSales(currentPage - 1);
    }
  }

  function nextPage() {
    loadSales(currentPage + 1);
  }

  // Dates par défaut (aujourd'hui)
  const today = new Date().toISOString().split('T')[0];
  const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
  document.getElementById('startDate').value = firstDayOfMonth;
  document.getElementById('endDate').value = today;

  // Charger au démarrage
  loadSales();
</script>

<%- include('partials/footer') %>
