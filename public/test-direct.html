<!DOCTYPE html>
<html>
<head>
    <title>Test Direct POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-8">
    <h1 class="text-2xl font-bold mb-4">Test Direct - Chargement Produits</h1>

    <form id="loginForm" class="mb-4 flex flex-col md:flex-row gap-2 md:items-end">
        <div>
            <label for="loginUsername" class="block text-sm font-medium">Utilisateur</label>
            <input id="loginUsername" type="text" class="border px-2 py-1 rounded w-40" placeholder="Nom d'utilisateur" required />
        </div>
        <div>
            <label for="loginPassword" class="block text-sm font-medium">Mot de passe</label>
            <input id="loginPassword" type="password" class="border px-2 py-1 rounded w-40" placeholder="Mot de passe" required />
        </div>
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">1. Test Login</button>
        <button type="button" onclick="testProducts()" class="bg-green-500 text-white px-4 py-2 rounded ml-2">2. Test Produits</button>
        <button type="button" onclick="clearAll()" class="bg-red-500 text-white px-4 py-2 rounded ml-2">Effacer tout</button>
    </form>

    <div id="result" class="bg-gray-100 p-4 rounded"></div>
    
    <script>
        function log(msg) {
            document.getElementById('result').innerHTML += `<p>${msg}</p>`;
        }
        
        function clearAll() {
            localStorage.clear();
            document.getElementById('result').innerHTML = '<p class="text-green-600">‚úÖ LocalStorage effac√©</p>';
        }
        
        async function testLogin(username, password) {
            document.getElementById('result').innerHTML = '';
            log('üîÑ Test de connexion...');
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });
                const data = await response.json();
                log(`Status: ${response.status}`);
                log(`R√©ponse: ${JSON.stringify(data, null, 2)}`);
                if (data.sessionId) {
                    localStorage.setItem('sessionId', data.sessionId);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    log('‚úÖ SessionId sauvegard√©: ' + data.sessionId.substring(0, 20) + '...');
                } else {
                    log('‚ùå Pas de sessionId dans la r√©ponse');
                }
            } catch (error) {
                log('‚ùå Erreur: ' + error.message);
            }
        }

        // Gestion du formulaire de login
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            testLogin(username, password);
        });
        
        async function testProducts() {
            document.getElementById('result').innerHTML = '';
            
            const sessionId = localStorage.getItem('sessionId');
            log('SessionId: ' + (sessionId ? sessionId.substring(0, 20) + '...' : '‚ùå MANQUANT'));
            
            if (!sessionId) {
                log('‚ö†Ô∏è Faites d\'abord le Test Login !');
                return;
            }
            
            log('üîÑ Chargement des produits...');
            
            try {
                const response = await fetch('/api/products', {
                    headers: {
                        'X-Session-Id': sessionId
                    }
                });
                
                log(`Status: ${response.status}`);
                
                const data = await response.json();
                log(`R√©ponse: ${JSON.stringify(data, null, 2)}`);
                
                if (data.products) {
                    log(`‚úÖ ${data.products.length} produits trouv√©s`);
                    data.products.forEach(p => {
                        log(`- ${p.name}: ${p.price} FC (Stock: ${p.stock})`);
                    });
                } else {
                    log('‚ùå Pas de produits');
                }
            } catch (error) {
                log('‚ùå Erreur: ' + error.message);
            }
        }
        
        // Auto-test au chargement
        window.onload = function() {
            const sessionId = localStorage.getItem('sessionId');
            if (sessionId) {
                log('‚ÑπÔ∏è Session trouv√©e: ' + sessionId.substring(0, 20) + '...');
                log('üëâ Cliquez sur "Test Produits" pour v√©rifier');
            } else {
                log('‚ÑπÔ∏è Pas de session');
                log('üëâ Cliquez sur "Test Login" d\'abord');
            }
        };
    </script>
</body>
</html>
